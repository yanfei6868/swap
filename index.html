<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å³æ—¶å…‘æ¢æ±‡ç‡å¯¹æ¯”ï¼ˆå¤šé“¾ç‰ˆï¼‰ v20251117-UI-OPTIMIZED</title>
<style>
Â Â body { font-family: -apple-system, "Helvetica Neue", Arial; margin: 12px; }
Â Â input, button, select, textarea { font-size: 15px; padding: 4px; border-radius: 4px; border: 1px solid #ccc; }
Â Â table { width: 100%; border-collapse: collapse; margin-top: 10px; }
Â Â th, td { border-bottom: 1px solid #ddd; padding: 8px; text-align:left; }
Â Â .ok { color: green; } .err { color: #c00; }
Â Â .small { font-size: 13px; color: #666; }
Â Â .adapter-item { border: 1px solid #eee; padding: 8px; margin: 6px 0; border-radius: 4px; background: #f9f9f9; }
Â Â .section-title { margin-top: 20px; border-bottom: 2px solid #555; padding-bottom: 5px; }
Â Â .config-area { border:1px solid #aaa;padding:8px;margin-top:16px;background:#f5f5f5;border-radius:4px; }
Â Â .summary { margin-top: 15px; padding: 10px; border: 1px solid #eee; border-radius: 4px; background: #f0f8ff; }
Â Â .summary b { font-size: 1.1em; }
Â Â .best-mark { color: green; font-weight: bold; margin-left: 4px; }
Â Â .output-cell { font-size: 1.05em; }
Â Â .output-cell.best { font-size: 1.15em; }
Â Â .warn-item { color: orange; font-weight: bold; margin-top: 5px; }
Â Â 
Â Â /* é€‚é…å™¨åˆ—è¡¨æ ·å¼ */
Â Â .adapter-filter-list { margin-top: 5px; padding: 5px; border: 1px dashed #ccc; background: #fff; max-height: 200px; overflow-y: auto; }
Â Â .adapter-filter-item { 
Â Â Â Â display: inline-block; padding: 4px 8px; margin: 3px; border: 1px solid #d0d0d0; border-radius: 4px; cursor: pointer; font-size: 13px; background: #fff; 
Â Â Â Â position: relative; 
Â Â Â Â padding-left: 18px; 
Â Â Â Â transition: all 0.2s ease-in-out; /* å¢åŠ è¿‡æ¸¡æ•ˆæœ */
Â Â }
Â Â .adapter-filter-item:hover { background: #e9e9e9; }

Â Â /* ã€ä¿®å¤ 3ã€‘ï¼šç¼–å·åŠ¨ç”»ä¸æ»‘ä¿®å¤ */
Â Â .adapter-filter-item span { 
Â Â Â Â display: inline-block;Â Â Â /* å¼ºåˆ¶ä½¿ç”¨å—å¸ƒå±€ï¼Œé˜²æ­¢é—ªçƒ */
Â Â }
Â Â 
Â Â /* ç‚¹å‡»åçš„é€‰ä¸­çŠ¶æ€ (Active) æ ·å¼å¢å¼º */
Â Â .adapter-filter-item.active { 
Â Â Â Â background: #ff5757; 
Â Â Â Â color: white; 
Â Â Â Â border-color: #ff5757; 
Â Â Â Â font-weight: bold;
Â Â Â Â box-shadow: 0 0 5px rgba(255, 87, 87, 0.5); 
Â Â }
Â Â .adapter-filter-item.locked { border-color: #28a745; }
Â Â .adapter-filter-item.locked.active { 
Â Â Â Â background: #32cd32; 
Â Â Â Â border-color: #32cd32;
Â Â Â Â box-shadow: 0 0 5px rgba(50, 205, 50, 0.5);
Â Â }

Â Â /* é€‰ä¸­ âœ… æ ‡è®°æ ·å¼ */
Â Â .adapter-filter-item.selected::before {
Â Â Â Â content: 'âœ…';
Â Â Â Â position: absolute;
Â Â Â Â left: 1px;
Â Â Â Â top: 50%;
Â Â Â Â transform: translateY(-50%) scale(0.75);
Â Â }
Â Â 
Â Â /* è”ç³»åŒºæ ·å¼ */
Â Â .contact-area { 
Â Â Â Â border: 1px solid #007bff;
Â Â Â Â padding: 10px;
Â Â Â Â margin-top: 20px;
Â Â Â Â background: #e6f7ff;
Â Â Â Â border-radius: 4px; 
Â Â }
Â Â .contact-area ul {
Â Â Â Â list-style: none;
Â Â Â Â padding-left: 0;
Â Â }
Â Â .contact-area li {
Â Â Â Â margin-bottom: 5px;
Â Â }
</style>
</head>
<body>
<h2>å³æ—¶å…‘æ¢æ±‡ç‡å¯¹æ¯”ï¼ˆå¤šé“¾ç‰ˆï¼‰</h2>

<div>
Â Â <label>å¸ç§From:<input id="from" style="width:80px"></label>
Â Â <label>é“¾From:<input id="fromNetwork" style="width:80px"></label>
Â Â <label>å¸ç§To:<input id="to" style="width:80px"></label>
Â Â <label>é“¾To:<input id="toNetwork" style="width:80px"></label>
Â Â <label>æ•°é‡:<input id="amount" style="width:80px"></label>

Â Â <label style="margin-left:12px;">
Â Â Â Â <input type="radio" name="mode" id="modeFloating" value="floating" checked> æŸ¥æµ®åŠ¨
Â Â </label>
Â Â <label>
Â Â Â Â <input type="radio" name="mode" id="modeLocked" value="locked"> æŸ¥é”å®š
Â Â </label>

Â Â <button id="compare" style="margin-left:8px;">ä¸€é”®æ¯”ä»·</button>
Â Â <button id="copyJson" style="margin-left:8px; display:none;">å¤åˆ¶ JSON</button>
</div>

<div id="status" class="small" style="margin:10px 0;">è¯·è®¾ç½® WORKER_URL</div>
<div id="warnings" style="margin:10px 0;"></div>

<h4 style="color:#007bff;">æµ®åŠ¨æ±‡ç‡</h4>
<table id="floatingTable"><thead><tr><th>äº¤æ˜“æ‰€</th><th>é¢„ä¼°è¾“å‡ºé‡</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
<div id="floatingSummary" class="summary" style="display:none;"></div>

<h4 style="color:#28a745;">é”å®šæ±‡ç‡</h4>
<table id="lockedTable"><thead><tr><th>äº¤æ˜“æ‰€</th><th>é¢„ä¼°è¾“å‡ºé‡</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
<div id="lockedSummary" class="summary" style="display:none;"></div>

<div class="config-area">
Â Â <h3 class="section-title">äº¤æ˜“æ‰€é€‚é…å™¨ç®¡ç†ï¼ˆéœ€å¯†ç ï¼‰Â Â </h3>
Â Â <div>
Â Â Â Â <input id="adminPass" type="password" placeholder="è¾“å…¥ç®¡ç†å¯†ç " style="width:140px;">
Â Â Â Â <button id="loadFromKV">ä»åç«¯åŠ è½½é…ç½®</button>
Â Â Â Â <button id="saveToKV">ä¿å­˜åˆ°åç«¯ (å«é€‚é…å™¨)</button>
Â Â Â Â <button id="lockCompareMode" style="margin-left:8px; display:none;">ğŸ”’ é”å®šæ¯”ä»·/éå¼€æº</button>
Â Â </div>

Â Â <div style="margin-top:10px;">
Â Â Â Â <button id="showAllAdapters" class="small" style="margin-bottom: 5px;">æ˜¾ç¤ºå…¨éƒ¨é€‚é…å™¨</button>
Â Â Â Â <div style="border:1px solid #007bff; padding: 5px; margin-top: 5px; border-radius: 4px;">
Â Â Â Â Â Â Â Â <div style="font-weight: bold; color: #007bff; font-size: 14px;">æµ®åŠ¨æ±‡ç‡åˆ—è¡¨ (Floating)</div>
Â Â Â Â Â Â Â Â <div id="floatingAdapterList" class="adapter-filter-list"></div>
Â Â Â Â </div>
Â Â Â Â 
Â Â Â Â <div style="border:1px solid #28a745; padding: 5px; margin-top: 10px; border-radius: 4px;">
Â Â Â Â Â Â Â Â <div style="font-weight: bold; color: #28a745; font-size: 14px;">é”å®šæ±‡ç‡åˆ—è¡¨ (Locked)</div>
Â Â Â Â Â Â Â Â <div id="lockedAdapterList" class="adapter-filter-list"></div>
Â Â Â Â </div>
Â Â </div>

Â Â <div class="small">å¯æ·»åŠ æˆ–åˆ é™¤è‡ªå®šä¹‰äº¤æ˜“æ‰€ APIã€‚é…ç½®å°†ä¿å­˜åˆ° Cloudflare Worker KV ä¸­ã€‚</div>
Â Â <button id="addAdapter" style="margin: 5px 0 10px 0;">æ–°å¢äº¤æ˜“æ‰€</button>
Â Â <div id="adapterList"></div>
</div>

<h2>å…¨å±€é…ç½®ç®¡ç†</h2>
<div id="admin-panel" class="config-area">
Â Â <input id="admin-pass" placeholder="ç®¡ç†å¯†ç " type="password" style="width:140px;" />
Â Â <input id="api-key" placeholder="ChangeNOW API Key" style="width:240px;" />
Â Â <button onclick="saveConfigWrapper(true)">ä¿å­˜å…¨å±€é…ç½®</button> 
Â Â <div style="margin-top:10px;">
Â Â Â Â <label>ç½‘ç»œåˆ«åæ˜ å°„ (NETWORK_ALIASES JSON): 
Â Â Â Â Â Â <textarea id="network-aliases-json" style="width:100%; height:120px;">
{
Â Â "BTC": "BITCOIN",
Â Â "ETH": "ETHEREUM",
Â Â "TRX": "TRON",
Â Â "BNB": "BSC",
Â Â "SOL": "SOLANA",
Â Â "MAINNET": "BITCOIN"
}
Â Â Â Â Â Â </textarea>
Â Â Â Â </label>
Â Â Â Â </div>
</div>

<div class="contact-area">
Â Â <h4 class="section-title" style="margin-top:0; border-bottom: none;">è”ç³»ä½œè€…</h4>
Â Â <p>æœ‰å»ºè®® / åˆä½œ / é—®é¢˜ï¼Ÿ</p>
Â Â <p>
Â Â Â Â <a id="mail" href="#" style="color:#007bff;"></a>
Â Â Â Â <br>
Â Â Â Â <a href="https://github.com/yourname/your-repo" target="_blank" rel="noopener">ğŸ™ GitHub ä»“åº“</a>
Â Â </p>
</div>


<script>
const WORKER_URL = 'https://your-worker.your-username.workers.dev'; 

// ã€ä¿®å¤ 4ã€‘ï¼šChangeNOW é»˜è®¤é€‚é…å™¨ä¿®å¤ï¼šä½¿ç”¨å›ºå®šä¼°ç®—å’Œ rate æ¨¡å¼
// åŸå§‹ç¡¬ç¼–ç çš„ä¸¤ä¸ª ChangeNOW é€‚é…å™¨å·²æ ¹æ®ç”¨æˆ·è¯·æ±‚åˆ é™¤ï¼Œadapters åˆå§‹åŒ–ä¸ºç©ºæ•°ç»„
let adapters = []; 
let queryPair = {}; 
let lastResults = null;
let visibleAdapterIndex = 'all'; 

function escapeHtml(s) {
Â Â if (!s) return '';
Â Â return s
Â Â Â Â .replace(/&/g, '&amp;')
Â Â Â Â .replace(/"/g, '&quot;')
Â Â Â Â .replace(/</g, '&lt;')
Â Â Â Â .replace(/>/g, '&gt;');
}

function buildRateRows(data, bestIdx = 0) {
Â Â return data.map((r, i) => {
Â Â Â Â const best = i === bestIdx && r.ok && r.outputAmount != null;
Â Â Â Â 
Â Â Â Â const outputDisplay = r.ok && r.outputAmount != null
Â Â Â Â Â Â ? `${Number(r.outputAmount).toFixed(6)} ${queryPair.to}`
Â Â Â Â Â Â : `<span class="err">${escapeHtml(r.error || 'å¤±è´¥')}</span>`;

Â Â Â Â const linkTag = r.ok && r.link && /^https?:\/\//i.test(r.link)
Â Â Â Â Â Â ? `<a href="${escapeHtml(r.link)}" target="_blank" rel="noopener">å‰å¾€</a>`
Â Â Â Â Â Â : '-';

Â Â Â Â return `
Â Â Â Â Â Â <tr>
Â Â Â Â Â Â Â Â <td>${escapeHtml(r.name || '-')}${best ? '<span class="best-mark">Best</span>' : ''}</td>
Â Â Â Â Â Â Â Â <td class="output-cell ${best ? 'best' : ''}" style="font-weight:${best?'bold':'normal'};color:${best?'green':'inherit'};">
Â Â Â Â Â Â Â Â Â Â ${outputDisplay}
Â Â Â Â Â Â Â Â </td>
Â Â Â Â Â Â Â Â <td>${linkTag}</td>
Â Â Â Â Â Â </tr>`;
Â Â }).join('');
}

// é€‚é…å™¨åç§°åˆ—è¡¨æ¸²æŸ“ (åŒ…å«ç¼–å·éšè—/æ˜¾ç¤ºé€»è¾‘)
function renderAdapterFilterList() {
Â Â const floatingList = document.getElementById('floatingAdapterList');
Â Â const lockedList = document.getElementById('lockedAdapterList');
Â Â floatingList.innerHTML = '';
Â Â lockedList.innerHTML = '';
Â Â 
Â Â adapters.forEach((a, i) => {
Â Â Â Â const listItem = document.createElement('span');
Â Â Â Â listItem.className = `adapter-filter-item ${a.rateType === 'locked' ? 'locked' : ''}`;
Â Â Â Â listItem.classList.toggle('selected', a.selected !== false); 
Â Â Â Â 
Â Â Â Â listItem.dataset.index = i;
Â Â Â Â listItem.dataset.rateType = a.rateType;

Â Â Â Â // 1. åˆ›å»ºç¼–å·å…ƒç´ ï¼ˆé»˜è®¤éšè—ï¼‰
Â Â Â Â const indexSpan = document.createElement('span');
Â Â Â Â indexSpan.textContent = `[#${i + 1}] `;
Â Â Â Â indexSpan.style.opacity = (i === visibleAdapterIndex) ? '1' : '0'; // é€‰ä¸­å¸¸æ˜¾
Â Â Â Â indexSpan.style.marginRight = '4px';
Â Â Â Â indexSpan.style.transition = 'opacity 0.2s'; 

Â Â Â Â // 2. åˆ›å»ºåç§°æ–‡æœ¬
Â Â Â Â const nameText = document.createTextNode(a.name || 'æœªå‘½å');
Â Â Â Â 
Â Â Â Â listItem.appendChild(indexSpan);
Â Â Â Â listItem.appendChild(nameText);
Â Â Â Â 
Â Â Â Â // 3. æ‚¬åœæ•ˆæœï¼šæ‚¬åœæ—¶æ˜¾ç¤ºæ•°å­—
Â Â Â Â listItem.onmouseover = () => { indexSpan.style.opacity = '1'; };
Â Â Â Â listItem.onmouseout = () => { if (i !== visibleAdapterIndex) indexSpan.style.opacity = '0'; };
Â Â Â Â 
Â Â Â Â // 4. ç‚¹å‡»åçš„é«˜äº®çŠ¶æ€
Â Â Â Â if (i === visibleAdapterIndex) {
Â Â Â Â Â Â Â Â listItem.classList.add('active');
Â Â Â Â }

Â Â Â Â listItem.onclick = () => showAdapter(i); 

Â Â Â Â if (a.rateType === 'floating') {
Â Â Â Â Â Â Â Â floatingList.appendChild(listItem);
Â Â Â Â } else if (a.rateType === 'locked') {
Â Â Â Â Â Â Â Â lockedList.appendChild(listItem);
Â Â Â Â }
Â Â });
}

function renderAdapters() {
Â Â const container = document.getElementById('adapterList');
Â Â const activeElement = document.activeElement;
Â Â 
Â Â container.innerHTML = '';

Â Â adapters.forEach((a, i) => {
Â Â Â Â const mappingsJson = a.mappings ? JSON.stringify(a.mappings, null, 2) : '';
Â Â Â Â const headersJson = a.headers ? JSON.stringify(a.headers, null, 2) : '';
Â Â Â Â 
Â Â Â Â let bodyVal = '';
Â Â Â Â if (a.body) {
Â Â Â Â Â Â Â Â bodyVal = typeof a.body === 'object' ? JSON.stringify(a.body, null, 2) : String(a.body);
Â Â Â Â }
Â Â Â Â const bodyJson = bodyVal;

Â Â Â Â let parsePathHint = '';
Â Â Â Â if (a.parseType === 'html_regex') {
Â Â Â Â Â Â parsePathHint = '<span class="err small">âš ï¸ éœ€è¦æ­£åˆ™è¡¨è¾¾å¼ (e.g., /.../g) ä¸”ä¸èƒ½ä¸ºç©º</span>';
Â Â Â Â }
Â Â Â Â 
Â Â Â Â const isBatchAPIOptions = `
Â Â Â Â Â Â Â Â <option value="true" ${a.isBatchAPI === true || a.isBatchAPI == null ? 'selected' : ''}>æ˜¯ (é»˜è®¤/true)</option>
Â Â Â Â Â Â Â Â <option value="false" ${a.isBatchAPI === false ? 'selected' : ''}>å¦ (false)</option>
Â Â Â Â `;

Â Â Â Â const div = document.createElement('div');
Â Â Â Â div.className = 'adapter-item';
Â Â Â Â div.dataset.index = i; 
Â Â Â Â 
Â Â Â Â if (visibleAdapterIndex !== i && visibleAdapterIndex !== 'all') {
Â Â Â Â Â Â Â Â div.style.display = 'none';
Â Â Â Â }

Â Â Â Â div.innerHTML = `
Â Â Â Â Â Â <label style="float:right; margin-right:10px;">
Â Â Â Â Â Â Â Â <input type="checkbox" data-i="${i}" class="adapter-selector" ${a.selected !== false ? 'checked' : ''}>
Â Â Â Â Â Â Â Â <b>æ¯”ä»·é€‰ä¸­</b>
Â Â Â Â Â Â </label>
Â Â Â Â Â Â <b>[#${i + 1}] ${escapeHtml(a.name || ('é€‚é…å™¨ ' + (i+1)))}</b><br>
Â Â Â Â Â Â <div class="small">æ˜¾ç¤ºåç§° (å‰ç«¯å¯ç¼–è¾‘):
Â Â Â Â Â Â Â Â <input data-i="${i}" class="name" value="${escapeHtml(a.name||'')}">
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <div class="small">URLæ¨¡æ¿: 
Â Â Â Â Â Â Â Â <input data-i="${i}" class="url" value="${escapeHtml(a.urlTemplate||'')}">
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <div class="small">é“¾æ¥æ¨¡æ¿: 
Â Â Â Â Â Â Â Â <input data-i="${i}" class="linkTemplate" value="${escapeHtml(a.linkTemplate||'')}">
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <div class="small">
Â Â Â Â Â Â Â Â <label>è¯·æ±‚æ–¹æ³•:
Â Â Â Â Â Â Â Â Â Â <select data-i="${i}" class="method">
Â Â Â Â Â Â Â Â Â Â Â Â <option value="GET" ${ (a.method||'GET').toUpperCase() === 'GET' ? 'selected' : '' }>GET</option>
Â Â Â Â Â Â Â Â Â Â Â Â <option value="POST" ${ (a.method||'GET').toUpperCase() === 'POST' ? 'selected' : '' }>POST</option>
Â Â Â Â Â Â Â Â Â Â </select>
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <div class="small">
Â Â Â Â Â Â Â Â <label>ç±»å‹:
Â Â Â Â Â Â Â Â Â Â <select data-i="${i}" class="rateType">
Â Â Â Â Â Â Â Â Â Â Â Â <option value="floating" ${a.rateType==='floating'?'selected':''}>æµ®åŠ¨</option>
Â Â Â Â Â Â Â Â Â Â Â Â <option value="locked" ${a.rateType==='locked'?'selected':''}>é”å®š</option>
Â Â Â Â Â Â Â Â Â Â </select>
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <label>è§£æç±»å‹:
Â Â Â Â Â Â Â Â <select data-i="${i}" class="parseType">
Â Â Â Â Â Â Â Â Â Â <option value="json" ${a.parseType==='json'?'selected':''}>json</option>
Â Â Â Â Â Â Â Â Â Â <option value="html_regex" ${a.parseType==='html_regex'?'selected':''}>html_regex</option>
Â Â Â Â Â Â Â Â </select>
Â Â Â Â Â Â </label>

Â Â Â Â Â Â <label>æ˜¯å¦ä¸ºæ‰¹é‡API (isBatchAPI):
Â Â Â Â Â Â Â Â <select data-i="${i}" class="isBatchAPI">
Â Â Â Â Â Â Â Â Â Â Â Â ${isBatchAPIOptions}
Â Â Â Â Â Â Â Â </select>
Â Â Â Â Â Â </label>

Â Â Â Â Â Â <label>è§£æç»“æœä¸º:
Â Â Â Â Â Â Â Â <select data-i="${i}" class="parseResultAs">
Â Â Â Â Â Â Â Â Â Â <option value="total" ${a.parseResultAs !== 'rate' ? 'selected' : ''}>æ€»ä»· (Total)</option>
Â Â Â Â Â Â Â Â Â Â <option value="rate" ${a.parseResultAs === 'rate' ? 'selected' : ''}>å•ä»· (Rate)</option>
Â Â Â Â Â Â Â Â </select>
Â Â Â Â Â Â </label>
Â Â Â Â Â Â <label>è·¯å¾„/Regex: 
Â Â Â Â Â Â Â Â <input data-i="${i}" class="parsePath" value="${escapeHtml(a.parsePath||'')}">
Â Â Â Â Â Â </label>
Â Â Â Â Â Â ${parsePathHint}
Â Â Â Â Â Â <br>
Â Â Â Â Â Â <div class="small">
Â Â Â Â Â Â Â Â <label>Headers (JSON):
Â Â Â Â Â Â Â Â Â Â <textarea data-i="${i}" class="headers" style="width:90%; height:70px;">${escapeHtml(headersJson)}</textarea>
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <div class="small">
Â Â Â Â Â Â Â Â <label>Body (JSON æˆ– è¡¨å•å­—ç¬¦ä¸²):
Â Â Â Â Â Â Â Â Â Â <textarea data-i="${i}" class="body" style="width:90%; height:70px;">${escapeHtml(bodyJson)}</textarea>
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <div class="small">
Â Â Â Â Â Â Â Â <label>å¸ç§/é“¾åæ˜ å°„ (Mappings JSON): 
Â Â Â Â Â Â Â Â Â Â <textarea data-i="${i}" class="mappings" style="width:90%; height: 80px;">${escapeHtml(mappingsJson)}</textarea>
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <div class="small">
Â Â Â Â Â Â Â Â <label>API Key (ä¼šä¿å­˜åˆ°åç«¯ KV): 
Â Â Â Â Â Â Â Â Â Â <input data-i="${i}" class="apiKey" value="${escapeHtml(a.apiKey||'')}">
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <button data-i="${i}" class="del">åˆ é™¤</button>
Â Â Â Â `;
Â Â Â Â container.appendChild(div);
Â Â });

Â Â const update = (e, p) => {
Â Â Â Â const i = Number(e.target.dataset.i);
Â Â Â Â const val = e.target.value.trim();

Â Â Â Â if (p === 'mappings' || p === 'headers' || p === 'body') {
Â Â Â Â Â Â Â Â if (val === '') {
Â Â Â Â Â Â Â Â Â Â Â Â delete adapters[i][p];
Â Â Â Â Â Â Â Â Â Â Â Â const elementToFocus = document.activeElement; 
Â Â Â Â Â Â Â Â Â Â Â Â renderAdapters(); 
Â Â Â Â Â Â Â Â Â Â Â Â if (elementToFocus) elementToFocus.focus();
Â Â Â Â Â Â Â Â Â Â Â Â return; 
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â if (p === 'body') {
Â Â Â Â Â Â Â Â Â Â Â Â try { 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â adapters[i].body = JSON.parse(val); 
Â Â Â Â Â Â Â Â Â Â Â Â } catch { 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â adapters[i].body = val;
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â } else { // mappings, headers
Â Â Â Â Â Â Â Â Â Â Â Â try {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â adapters[i][p] = JSON.parse(val);
Â Â Â Â Â Â Â Â Â Â Â Â } catch (err) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â alert(`${p} å­—æ®µ JSON æ ¼å¼é”™è¯¯: ` + err.message);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â }
Â Â Â Â } else {
Â Â Â Â Â Â if (p === 'parseType') {
Â Â Â Â Â Â Â Â Â Â adapters[i][p] = val;
Â Â Â Â Â Â Â Â Â Â const elementToFocus = document.activeElement;
Â Â Â Â Â Â Â Â Â Â renderAdapters(); 
Â Â Â Â Â Â Â Â Â Â if (elementToFocus) elementToFocus.focus();
Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â }
Â Â Â Â Â Â adapters[i][p] = val;
Â Â Â Â }
Â Â };
Â Â 
Â Â container.querySelectorAll('.name').forEach(inp => inp.onchange = e => { 
Â Â Â Â update(e, 'name'); 
Â Â Â Â renderAdapterFilterList(); 
Â Â });
Â Â container.querySelectorAll('.url').forEach(inp => inp.onchange = e => update(e, 'urlTemplate'));
Â Â container.querySelectorAll('.linkTemplate').forEach(inp => inp.onchange = e => update(e, 'linkTemplate'));
Â Â container.querySelectorAll('.method').forEach(sel => sel.onchange = e => update(e, 'method'));
Â Â 
Â Â container.querySelectorAll('.rateType').forEach(sel => sel.onchange = e => { 
Â Â Â Â const elementToFocus = document.activeElement;
Â Â Â Â update(e, 'rateType'); 
Â Â Â Â renderAdapters(); 
Â Â Â Â if (elementToFocus) elementToFocus.focus();
Â Â }); 

Â Â container.querySelectorAll('.parseType').forEach(sel => sel.onchange = e => update(e, 'parseType'));
Â Â container.querySelectorAll('.parsePath').forEach(inp => inp.onchange = e => update(e, 'parsePath'));
Â Â container.querySelectorAll('.parseResultAs').forEach(sel => sel.onchange = e => update(e, 'parseResultAs')); 
Â Â container.querySelectorAll('.mappings').forEach(ta => ta.onchange = e => update(e, 'mappings'));Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â container.querySelectorAll('.apiKey').forEach(inp => inp.onchange = e => update(e, 'apiKey'));
Â Â container.querySelectorAll('.headers').forEach(ta => ta.onchange = e => update(e, 'headers'));
Â Â container.querySelectorAll('.body').forEach(ta => ta.onchange = e => update(e, 'body'));
Â Â container.querySelectorAll('.del').forEach(btn => btn.onclick = e => {
Â Â Â Â adapters.splice(Number(e.target.dataset.i), 1);
Â Â Â Â visibleAdapterIndex = null; 
Â Â Â Â renderAdapters();
Â Â });

Â Â container.querySelectorAll('.adapter-selector').forEach(chk => chk.onchange = e => {
Â Â Â Â const i = Number(e.target.dataset.i);
Â Â Â Â adapters[i].selected = e.target.checked;
Â Â Â Â if (adapters[i].selected === true) delete adapters[i].selected;
Â Â Â Â renderAdapterFilterList(); 
Â Â });

Â Â container.querySelectorAll('.isBatchAPI').forEach(sel => sel.onchange = e => {
Â Â Â Â const i = Number(e.target.dataset.i);
Â Â Â Â const val = e.target.value.trim();
Â Â Â Â if (val === 'true') {
Â Â Â Â Â Â Â Â delete adapters[i].isBatchAPI;
Â Â Â Â } else { 
Â Â Â Â Â Â Â Â adapters[i].isBatchAPI = false;
Â Â Â Â }
Â Â });

Â Â if (activeElement && activeElement.focus && activeElement.matches('input, textarea, select')) {
Â Â Â Â const target = container.querySelector(`[data-i="${activeElement.dataset.i}"].${activeElement.className.split(/\s+/).pop()}`);
Â Â Â Â if (target) target.focus();
Â Â }
Â Â 
Â Â renderAdapterFilterList();

Â Â if (visibleAdapterIndex !== null && visibleAdapterIndex !== 'all') {
Â Â Â Â const newDiv = container.querySelector(`[data-index="${visibleAdapterIndex}"]`);
Â Â Â Â if (newDiv) newDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
Â Â }
}

function showAdapter(index) {
Â Â Â Â visibleAdapterIndex = index;
Â Â Â Â document.getElementById('adapterList').querySelectorAll('.adapter-item').forEach(div => {
Â Â Â Â Â Â Â Â div.style.display = (Number(div.dataset.index) === index) ? 'block' : 'none';
Â Â Â Â });
Â Â Â Â renderAdapterFilterList();
Â Â Â Â 
Â Â Â Â const target = document.querySelector(`[data-index="${index}"]`);
Â Â Â Â if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

document.getElementById('showAllAdapters').onclick = () => {
Â Â Â Â visibleAdapterIndex = 'all';
Â Â Â Â document.getElementById('adapterList').querySelectorAll('.adapter-item').forEach(div => {
Â Â Â Â Â Â Â Â div.style.display = 'block';
Â Â Â Â });
Â Â Â Â renderAdapterFilterList(); 
}

document.getElementById('addAdapter').onclick = () => {
Â Â adapters.unshift({ 
Â Â Â Â name: 'æ–°äº¤æ˜“æ‰€', 
Â Â Â Â urlTemplate: '', 
Â Â Â Â method: 'GET', 
Â Â Â Â parseType: 'json', 
Â Â Â Â parsePath: '', 
Â Â Â Â parseResultAs: 'total',Â Â 
Â Â Â Â rateType: 'floating',
Â Â });
Â Â visibleAdapterIndex = 0; 
Â Â renderAdapters();
};

function disableAdminIfNoWorker() {
Â Â const disabled = !WORKER_URL || WORKER_URL.includes('your-worker');
Â Â const loadBtn = document.getElementById('loadFromKV');
Â Â const saveBtn = document.getElementById('saveToKV');
Â Â const compareBtn = document.getElementById('compare');
Â Â const lockBtn = document.getElementById('lockCompareMode');
Â Â 
Â Â loadBtn.disabled = disabled;Â Â 
Â Â saveBtn.disabled = disabled;Â Â 
Â Â 
Â Â compareBtn.disabled = disabled; 
Â Â lockBtn.disabled = disabled;
Â Â 
Â Â document.getElementById('status').textContent = disabled 
Â Â Â Â ? 'è¯·ä¿®æ”¹ WORKER_URL ä¸ºä½ çš„ Cloudflare Worker åœ°å€' 
Â Â Â Â : 'Worker å·²è¿æ¥';
}
disableAdminIfNoWorker();

document.getElementById('loadFromKV').onclick = async () => {
Â Â const pass = document.getElementById('adminPass').value.trim();
Â Â if (!pass) return alert('è¯·è¾“å…¥ç®¡ç†å¯†ç ');
Â Â try {
Â Â Â Â const res = await fetch(WORKER_URL + '/getConfig', {
Â Â Â Â Â Â method: 'POST',
Â Â Â Â Â Â headers: { 'content-type': 'application/json' },
Â Â Â Â Â Â body: JSON.stringify({ pass })
Â Â Â Â });
Â Â Â Â if (!res.ok) throw new Error(await res.text() || 'HTTP ' + res.status);
Â Â Â Â const json = await res.json();
Â Â Â Â adapters = Array.isArray(json.adapters) ? json.adapters : [];
Â Â Â Â 
Â Â Â Â if (json.CHANGENOW_API_KEY) {
Â Â Â Â Â Â document.getElementById('api-key').value = json.CHANGENOW_API_KEY;
Â Â Â Â }
Â Â Â Â 
Â Â Â Â const networkAliasesJson = JSON.stringify(json.networkAliases || {}, null, 2);
Â Â Â Â document.getElementById('network-aliases-json').value = networkAliasesJson;
Â Â Â Â 
Â Â Â Â visibleAdapterIndex = 'all'; 
Â Â Â Â alert('é…ç½®åŠ è½½æˆåŠŸ');
Â Â Â Â renderAdapters();
Â Â } catch (err) {
Â Â Â Â alert('åŠ è½½å¤±è´¥ï¼š' + err.message);
Â Â } finally {
Â Â Â Â document.getElementById('adminPass').value = '';
Â Â }
};

async function saveConfigWrapper(onlyGlobal) {
Â Â const pass = document.getElementById(onlyGlobal ? 'admin-pass' : 'adminPass').value.trim();
Â Â const verb = onlyGlobal ? 'å…¨å±€é…ç½®' : 'é…ç½® (å«é€‚é…å™¨)';
Â Â 
Â Â if (!pass) return alert(`è¯·è¾“å…¥ç®¡ç†å¯†ç è¿›è¡Œ ${verb} æ“ä½œ`);
Â Â 
Â Â try {
Â Â Â Â const networkAliasesStr = document.getElementById('network-aliases-json').value.trim();
Â Â Â Â let networkAliases = {};
Â Â Â Â try {
Â Â Â Â Â Â Â Â networkAliases = JSON.parse(networkAliasesStr);
Â Â Â Â Â Â Â Â if (typeof networkAliases !== 'object' || Array.isArray(networkAliases)) throw new Error('ä¸æ˜¯æœ‰æ•ˆçš„å¯¹è±¡');
Â Â Â Â } catch (e) {
Â Â Â Â Â Â Â Â alert('ç½‘ç»œåˆ«åæ˜ å°„ JSON æ ¼å¼é”™è¯¯: ' + e.message);
Â Â Â Â Â Â Â Â return; 
Â Â Â Â }

Â Â Â Â const globalConfig = { 
Â Â Â Â Â Â Â Â CHANGENOW_API_KEY: document.getElementById('api-key').value.trim(),
Â Â Â Â Â Â Â Â networkAliases: networkAliases
Â Â Â Â };
Â Â Â Â 
Â Â Â Â const payload = { pass, config: globalConfig };
Â Â Â Â 
Â Â Â Â if (!onlyGlobal) {
Â Â Â Â Â Â Â Â payload.adapters = adapters.map(a => ({ ...a }));
Â Â Â Â }

Â Â Â Â const res = await fetch(WORKER_URL + '/saveConfig', {
Â Â Â Â Â Â method: 'POST',
Â Â Â Â Â Â headers: { 'content-type': 'application/json' },
Â Â Â Â Â Â body: JSON.stringify(payload)
Â Â Â Â });
Â Â Â Â const txt = await res.text();
Â Â Â Â if (!res.ok) throw new Error(txt || 'HTTP ' + res.status);
Â Â Â Â alert(`${verb} ä¿å­˜æˆåŠŸï¼`);
Â Â } catch (err) {
Â Â Â Â alert(`${verb} ä¿å­˜å¤±è´¥ï¼š` + err.message);
Â Â } finally {
Â Â Â Â document.getElementById('adminPass').value = '';
Â Â Â Â document.getElementById('admin-pass').value = '';
Â Â }
};

document.getElementById('saveToKV').onclick = () => saveConfigWrapper(false);


document.getElementById('compare').onclick = async () => {
Â Â const from = document.getElementById('from').value.trim().toUpperCase() || null;
Â Â const to = document.getElementById('to').value.trim().toUpperCase() || null;
Â Â const fromNetwork = document.getElementById('fromNetwork').value.trim().toUpperCase() || null;
Â Â const toNetwork = document.getElementById('toNetwork').value.trim().toUpperCase() || null;
Â Â const amount = Number(document.getElementById('amount').value.trim());
Â Â 
Â Â if (!from || !to) return alert('è¯·è¾“å…¥å¸ç§ From å’Œ To');
Â Â if (isNaN(amount) || amount <= 0) return alert('æ•°é‡å¿…é¡»æ˜¯å¤§äº 0 çš„æœ‰æ•ˆæ•°å­—'); 

Â Â queryPair = { 
Â Â Â Â from: from, 
Â Â Â Â to: to, 
Â Â Â Â fromNetwork: fromNetwork, 
Â Â Â Â toNetwork: toNetwork, 
Â Â Â Â amount: amount 
Â Â };

Â Â const selectedMode = document.querySelector('input[name="mode"]:checked').value;
Â Â 
Â Â const selectedAdapters = adapters.filter(a => a.selected !== false); 
Â Â 
Â Â const adaptersToSend = selectedAdapters.filter(a => a.rateType === selectedMode);

Â Â if (adaptersToSend.length === 0) {
Â Â Â Â Â Â document.getElementById('status').textContent = `é”™è¯¯: æœªæ‰¾åˆ°åŒ¹é…æ¨¡å¼ "${selectedMode}" çš„é€‚é…å™¨ã€‚`;
Â Â Â Â Â Â return;
Â Â }
Â Â 
Â Â document.getElementById('status').textContent = 'æŸ¥è¯¢ä¸­...';
Â Â document.getElementById('warnings').innerHTML = ''; 
Â Â ['#floatingTable tbody', '#lockedTable tbody'].forEach(s => document.querySelector(s).innerHTML = '');
Â Â ['#floatingSummary', '#lockedSummary'].forEach(s => document.querySelector(s).style.display = 'none');
Â Â document.getElementById('copyJson').style.display = 'none';

Â Â const controller = new AbortController();
Â Â const timeout = setTimeout(() => controller.abort(), 15000);

Â Â try {
Â Â Â Â const requestBody = { 
Â Â Â Â Â Â pair: queryPair, 
Â Â Â Â Â Â adapters: adaptersToSend, 
Â Â Â Â };

Â Â Â Â const res = await fetch(WORKER_URL, {
Â Â Â Â Â Â method: 'POST',
Â Â Â Â Â Â headers: { 'content-type': 'application/json' },
Â Â Â Â Â Â signal: controller.signal,
Â Â Â Â Â Â body: JSON.stringify(requestBody)
Â Â Â Â });

Â Â Â Â if (!res.ok) {
Â Â Â Â Â Â const txt = await res.text().catch(()=>null);
Â Â Â Â Â Â throw new Error(txt || `HTTP ${res.status}`);
Â Â Â Â }
Â Â Â Â const results = await res.json();
Â Â Â Â lastResults = results;
Â Â Â Â showResults(results);
Â Â Â Â 
Â Â Â Â const total = Array.isArray(results.results) ? results.results.length : 0;
Â Â Â Â document.getElementById('status').textContent = `å®Œæˆï¼Œå…± ${total} æ¡ï¼Œè€—æ—¶ ${results.timeTaken || '?'}ms`;
Â Â Â Â document.getElementById('copyJson').style.display = 'inline-block';
Â Â } catch (e) {
Â Â Â Â document.getElementById('status').textContent = e.name === 'AbortError' ? 'è¯·æ±‚è¶…æ—¶' : 'é”™è¯¯: ' + e.message;
Â Â } finally {
Â Â Â Â clearTimeout(timeout);
Â Â }
};

document.getElementById('copyJson').onclick = () => {
Â Â if (!lastResults) return alert('æ— æ•°æ®');
Â Â const jsonContent = JSON.stringify(lastResults, null, 2); // æå– JSON å†…å®¹

Â Â navigator.clipboard.writeText(jsonContent)
Â Â Â Â .then(() => alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'))
Â Â Â Â .catch(() => {
Â Â Â Â Â Â // ã€ä¿®å¤ 1ã€‘ï¼šå¤åˆ¶å¤±è´¥ Fallback
Â Â Â Â Â Â prompt('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å…¨é€‰å¤åˆ¶:', jsonContent);
Â Â Â Â });
};


function showResults(results) {
Â Â const allResults = results?.results || [];
Â Â const floating = allResults.filter(r => r?.rateType === 'floating');
Â Â const locked = allResults.filter(r => r?.rateType === 'locked');
Â Â 
Â Â const sortFn = (a, b) => (b.outputAmount ?? -Infinity) - (a.outputAmount ?? -Infinity);
Â Â 
Â Â floating.sort(sortFn);
Â Â locked.sort(sortFn);
Â Â 
Â Â const floatingHtml = buildRateRows(floating, 0);
Â Â document.querySelector('#floatingTable tbody').innerHTML = floatingHtml;

Â Â const lockedHtml = buildRateRows(locked, 0);
Â Â document.querySelector('#lockedTable tbody').innerHTML = lockedHtml;
Â Â 
Â Â renderSummary(floating.filter(r => r.ok), '#floatingSummary', floating[0]);
Â Â renderSummary(locked.filter(r => r.ok), '#lockedSummary', locked[0]);

Â Â const warnings = results.warnings || [];
Â Â const warningsDiv = document.getElementById('warnings');
Â Â warningsDiv.innerHTML = ''; 

Â Â if (warnings.length > 0) {
Â Â Â Â Â Â warnings.forEach(w => {
Â Â Â Â Â Â Â Â Â Â const div = document.createElement('div');
Â Â Â Â Â Â Â Â Â Â div.className = 'warn-item';
Â Â Â Â Â Â Â Â Â Â div.textContent = `âš ï¸ [${w.adapter || 'å…¨å±€'}]: ${w.message || w.error || 'Worker æ—¥å¿—è­¦å‘Š'}`;
Â Â Â Â Â Â Â Â Â Â warningsDiv.appendChild(div);
Â Â Â Â Â Â });
Â Â }
}

function renderSummary(data, selector, bestResult) {
Â Â const div = document.querySelector(selector);
Â Â if (!data.length || !bestResult?.outputAmount) {
Â Â Â Â div.style.display = 'none';
Â Â Â Â return;
Â Â }
Â Â div.style.display = 'block';
Â Â div.innerHTML = `
Â Â Â Â <p>è¾“å…¥: <b>${queryPair.amount} ${queryPair.from}</b></p>
Â Â Â Â <p>æœ€ä¼˜ (<b>${escapeHtml(bestResult.name)}</b>): 
Â Â Â Â Â Â Â <b style="color:green; font-size: 1.2em;">${Number(bestResult.outputAmount).toFixed(6)} ${queryPair.to}</b>
Â Â Â Â </p>
Â Â `;
}

// ã€ä¿®å¤ 2ã€‘ï¼šé‚®ç®±çˆ¬è™«é˜²æŠ¤ï¼šåŠ¨æ€æ‹¼æ¥é‚®ç®±
const setupEmail = () => {
Â Â Â Â // è¯·æ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„é‚®ç®±ä¿¡æ¯
Â Â Â Â const user = 'yanfei6868'; 
Â Â Â Â const domain = 'icloud.com'; 
Â Â Â Â const mailElement = document.getElementById('mail');

Â Â Â Â if (mailElement) {
Â Â Â Â Â Â Â Â const fullEmail = user + '@' + domain;
Â Â Â Â Â Â Â Â mailElement.href = 'mailto:' + fullEmail;
Â Â Â Â Â Â Â Â mailElement.textContent = 'ğŸ“§ ' + fullEmail;
Â Â Â Â }
};
setupEmail();
</script>
</body>
</html>
