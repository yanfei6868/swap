<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>即时兑换汇率对比（多链版） v20251117-KV-CONFIG-FIXED</title>
<style>
  body { font-family: -apple-system, "Helvetica Neue", Arial; margin: 12px; }
  input, button, select, textarea { font-size: 15px; padding: 4px; border-radius: 4px; border: 1px solid #ccc; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { border-bottom: 1px solid #ddd; padding: 8px; text-align:left; }
  .ok { color: green; } .err { color: #c00; }
  .small { font-size: 13px; color: #666; }
  .adapter-item { border: 1px solid #eee; padding: 8px; margin: 6px 0; border-radius: 4px; background: #f9f9f9; }
  .section-title { margin-top: 20px; border-bottom: 2px solid #555; padding-bottom: 5px; }
  .config-area { border:1px solid #aaa;padding:8px;margin-top:16px;background:#f5f5f5;border-radius:4px; }
  .summary { margin-top: 15px; padding: 10px; border: 1px solid #eee; border-radius: 4px; background: #f0f8ff; }
  .summary b { font-size: 1.1em; }
  .best-mark { color: green; font-weight: bold; margin-left: 4px; }
  .small-muted { font-size:12px;color:#999;margin-left:6px;}
  .output-cell { font-size: 1.05em; }
  .output-cell.best { font-size: 1.15em; }
  .warn-item { color: orange; font-weight: bold; margin-top: 5px; }
</style>
</head>
<body>
<h2>即时兑换汇率对比（多链版）</h2>

<div>
  <label>币种From:<input id="from" style="width:80px"></label>
  <label>链From:<input id="fromNetwork" style="width:80px"></label>
  <label>币种To:<input id="to" style="width:80px"></label>
  <label>链To:<input id="toNetwork" style="width:80px"></label>
  <label>数量:<input id="amount" style="width:80px"></label>

  <label style="margin-left:12px;">
    <input type="radio" name="mode" id="modeFloating" value="floating" checked> 查浮动
  </label>
  <label>
    <input type="radio" name="mode" id="modeLocked" value="locked"> 查锁定
  </label>

  <button id="compare" style="margin-left:8px;">一键比价</button>
  <button id="copyJson" style="margin-left:8px; display:none;">复制 JSON</button>
</div>

<div id="status" class="small" style="margin:10px 0;">请设置 WORKER_URL</div>
<div id="warnings" style="margin:10px 0;"></div>

<h4 style="color:#007bff;">浮动汇率</h4>
<table id="floatingTable"><thead><tr><th>交易所</th><th>预估输出量</th><th>操作</th></tr></thead><tbody></tbody></table>
<div id="floatingSummary" class="summary" style="display:none;"></div>

<h4 style="color:#28a745;">锁定汇率</h4>
<table id="lockedTable"><thead><tr><th>交易所</th><th>预估输出量</th><th>操作</th></tr></thead><tbody></tbody></table>
<div id="lockedSummary" class="summary" style="display:none;"></div>

<div class="config-area">
  <h3 class="section-title">交易所适配器管理（需密码）</h3>
  <div>
    <input id="adminPass" type="password" placeholder="输入管理密码" style="width:140px;">
    <button id="loadFromKV">从后端加载配置</button>
    <button id="saveToKV">保存到后端 (含适配器)</button>
    <button id="addAdapter">新增交易所</button>
  </div>
  <div class="small">可添加或删除自定义交易所 API。配置将保存到 Cloudflare Worker KV 中。</div>
  <div id="adapterList"></div>
</div>

<h2>全局配置管理</h2>
<div id="admin-panel" class="config-area">
  <input id="admin-pass" placeholder="管理密码" type="password" style="width:140px;" />
  <input id="api-key" placeholder="ChangeNOW API Key" style="width:240px;" />
  <button onclick="saveConfigWrapper(true)">保存全局配置</button> 
  <div class="small-muted">全局 API Key 仅作 adapter 未提供 apiKey 时的回退。</div>
  
  <div style="margin-top:10px;">
    <label>网络别名映射 (NETWORK_ALIASES JSON): 
      <textarea id="network-aliases-json" style="width:100%; height:120px;">
{
  "BTC": "BITCOIN",
  "ETH": "ETHEREUM",
  "TRX": "TRON",
  "BNB": "BSC",
  "SOL": "SOLANA",
  "MAINNET": "BITCOIN"
}
      </textarea>
    </label>
    <div class="small-muted">格式: {"前端输入缩写": "Worker内部标准全称"}。注意 JSON 格式。</div>
  </div>
</div>

<script>
// ==================== 请在此处修改你的 Worker 地址 ====================
const WORKER_URL = 'https://odd-union-3737.yanfei6868.workers.dev'; 
// ==================================================================

let adapters = [];
let queryPair = {}; 
let lastResults = null;

function escapeHtml(s) {
  if (!s) return '';
  return s
    .replace(/&/g, '&amp;')
    .replace(/"/g, '&quot;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/'/g, '&#39;');
}

/* ---------- Render adapter editor ---------- */
function renderAdapters() {
  const container = document.getElementById('adapterList');
  container.innerHTML = '';
  adapters.forEach((a, i) => {
    // 渲染时，如果字段不存在则渲染为空字符串 (保持 delete 后的空状态)
    const mappingsJson = a.mappings ? JSON.stringify(a.mappings, null, 2) : '';
    const headersJson = a.headers ? JSON.stringify(a.headers, null, 2) : '';
    
    let bodyVal = '';
    if (a.body) {
        bodyVal = typeof a.body === 'object' ? JSON.stringify(a.body, null, 2) : String(a.body);
    }
    const bodyJson = bodyVal;

    // 修正 3: html_regex 提示
    let parsePathHint = '';
    if (a.parseType === 'html_regex') {
      parsePathHint = '<span class="err small">⚠️ 需要正则表达式 (e.g., /.../g) 且不能为空</span>';
    }

    const div = document.createElement('div');
    div.className = 'adapter-item';
    div.innerHTML = `
      <label style="float:right; margin-right:10px;">
        <input type="checkbox" data-i="${i}" class="adapter-selector" ${a.selected !== false ? 'checked' : ''}>
        <b>比价选中</b>
      </label>
      <b>${escapeHtml(a.name || ('适配器 ' + (i+1)))}</b><br>
      <div class="small">显示名称 (前端可编辑):
        <input data-i="${i}" class="name" value="${escapeHtml(a.name||'')}">
      </div>
      <div class="small">URL模板: 
        <input data-i="${i}" class="url" value="${escapeHtml(a.urlTemplate||'')}">
      </div>
      <div class="small">链接模板: 
        <input data-i="${i}" class="linkTemplate" value="${escapeHtml(a.linkTemplate||'')}">
      </div>
      <div class="small">
        <label>请求方法:
          <select data-i="${i}" class="method">
            <option value="GET" ${ (a.method||'GET').toUpperCase() === 'GET' ? 'selected' : '' }>GET</option>
            <option value="POST" ${ (a.method||'GET').toUpperCase() === 'POST' ? 'selected' : '' }>POST</option>
          </select>
        </label>
      </div>
      <div class="small">
        <label>类型:
          <select data-i="${i}" class="rateType">
            <option value="floating" ${a.rateType==='floating'?'selected':''}>浮动</option>
            <option value="locked" ${a.rateType==='locked'?'selected':''}>锁定</option>
          </select>
        </label>
      </div>
      <label>解析类型:
        <select data-i="${i}" class="parseType">
          <option value="json" ${a.parseType==='json'?'selected':''}>json</option>
          <option value="html_regex" ${a.parseType==='html_regex'?'selected':''}>html_regex</option>
        </select>
      </label>

      <label>是否为批量API (isBatchAPI):
        <select data-i="${i}" class="isBatchAPI">
          <option value="" ${a.isBatchAPI == null ? 'selected' : ''}>Worker默认 (是/true)</option>
          <option value="true" ${a.isBatchAPI === true ? 'selected' : ''}>是 (true)</option>
          <option value="false" ${a.isBatchAPI === false ? 'selected' : ''}>否 (false)</option>
        </select>
      </label>

      <label>解析结果为:
        <select data-i="${i}" class="parseResultAs">
          <option value="total" ${a.parseResultAs !== 'rate' ? 'selected' : ''}>总价 (Total)</option>
          <option value="rate" ${a.parseResultAs === 'rate' ? 'selected' : ''}>单价 (Rate)</option>
        </select>
      </label>
      <label>路径/Regex: 
        <input data-i="${i}" class="parsePath" value="${escapeHtml(a.parsePath||'')}">
      </label>
      ${parsePathHint}
      <br>
      <div class="small">
        <label>Headers (JSON):
          <textarea data-i="${i}" class="headers" style="width:90%; height:70px;">${escapeHtml(headersJson)}</textarea>
        </label>
      </div>
      <div class="small">
        <label>Body (JSON 或 表单字符串):
          <textarea data-i="${i}" class="body" style="width:90%; height:70px;">${escapeHtml(bodyJson)}</textarea>
        </label>
      </div>
      <div class="small">
        <label>币种/链名映射 (Mappings JSON): 
          <textarea data-i="${i}" class="mappings" style="width:90%; height: 80px;">${escapeHtml(mappingsJson)}</textarea>
        </label>
      </div>
      <div class="small">
        <label>API Key (会保存到后端 KV): 
          <input data-i="${i}" class="apiKey" value="${escapeHtml(a.apiKey||'')}">
        </label>
      </div>
      <button data-i="${i}" class="del">删除</button>
    `;
    container.appendChild(div);
  });

  const update = (e, p) => {
    const i = Number(e.target.dataset.i);
    const val = e.target.value.trim(); // 获取并清理输入值

    if (p === 'mappings' || p === 'headers' || p === 'body') {
        // 修正 2: 如果输入为空，删除字段以使用后端缺省值（保持原有逻辑，因为删除字段是与后端缺省行为一致的最佳方式）
        if (val === '') {
            delete adapters[i][p];
            renderAdapters(); // 重新渲染以确保 UI 状态正确反映字段删除 (例如，html_regex提示可能消失)
            return; 
        }
        
        if (p === 'body') {
            try { 
                adapters[i].body = JSON.parse(val); 
            } catch { 
                adapters[i].body = val; // 无法解析为 JSON，则作为纯字符串保存
            }
        } else { // mappings, headers
            try {
                adapters[i][p] = JSON.parse(val);
            } catch (err) {
                alert(`${p} 字段 JSON 格式错误: ` + err.message);
                return;
            }
        }
    } else {
      // 检查 parseType/parsePath 的联动（非 JSON/对象字段）
      if (p === 'parseType') {
          adapters[i][p] = val;
          renderAdapters(); // 重新渲染以更新 html_regex 提示
          return;
      }
      // 非 JSON/对象字段，直接保存清理后的值
      adapters[i][p] = val;
    }
  };

  container.querySelectorAll('.name').forEach(inp => inp.onchange = e => update(e, 'name'));
  container.querySelectorAll('.url').forEach(inp => inp.onchange = e => update(e, 'urlTemplate'));
  container.querySelectorAll('.linkTemplate').forEach(inp => inp.onchange = e => update(e, 'linkTemplate'));
  container.querySelectorAll('.method').forEach(sel => sel.onchange = e => update(e, 'method'));
  container.querySelectorAll('.rateType').forEach(sel => sel.onchange = e => update(e, 'rateType'));
  container.querySelectorAll('.parseType').forEach(sel => sel.onchange = e => update(e, 'parseType'));
  container.querySelectorAll('.parsePath').forEach(inp => inp.onchange = e => update(e, 'parsePath'));
  container.querySelectorAll('.parseResultAs').forEach(sel => sel.onchange = e => update(e, 'parseResultAs')); 
  container.querySelectorAll('.mappings').forEach(ta => ta.onchange = e => update(e, 'mappings'));             
  container.querySelectorAll('.apiKey').forEach(inp => inp.onchange = e => update(e, 'apiKey'));
  container.querySelectorAll('.headers').forEach(ta => ta.onchange = e => update(e, 'headers'));
  container.querySelectorAll('.body').forEach(ta => ta.onchange = e => update(e, 'body'));
  container.querySelectorAll('.del').forEach(btn => btn.onclick = e => {
    adapters.splice(Number(e.target.dataset.i), 1);
    renderAdapters();
  });

  // 【新增】功能 1: 适配器选择器事件处理
  container.querySelectorAll('.adapter-selector').forEach(chk => chk.onchange = e => {
    const i = Number(e.target.dataset.i);
    adapters[i].selected = e.target.checked;
    if (adapters[i].selected === true) {
        delete adapters[i].selected;
    }
  });

  // 【新增】功能 2: isBatchAPI 下拉框事件处理
  container.querySelectorAll('.isBatchAPI').forEach(sel => sel.onchange = e => {
    const i = Number(e.target.dataset.i);
    const val = e.target.value.trim();

    if (val === '') {
        // 选择 "默认"，删除字段，让 Worker 使用其默认值 (true)
        delete adapters[i].isBatchAPI; 
    } else {
        // 转换为布尔值 true 或 false
        adapters[i].isBatchAPI = val === 'true'; 
    }
  });
}

document.getElementById('addAdapter').onclick = () => {
  adapters.push({ 
    name: '新交易所', 
    urlTemplate: '', 
    method: 'GET', 
    parseType: 'json', 
    parsePath: '', 
    parseResultAs: 'total',  
    rateType: 'floating',
  });
  renderAdapters();
};

function disableAdminIfNoWorker() {
  const disabled = !WORKER_URL || WORKER_URL.includes('your-worker');
  const loadBtn = document.getElementById('loadFromKV');
  const saveBtn = document.getElementById('saveToKV');
  const compareBtn = document.getElementById('compare');
  loadBtn.disabled = disabled;
  saveBtn.disabled = disabled;
  compareBtn.disabled = disabled;
  document.getElementById('status').textContent = disabled 
    ? '请修改 WORKER_URL 为你的 Cloudflare Worker 地址' 
    : 'Worker 已连接';
}
disableAdminIfNoWorker();

document.getElementById('loadFromKV').onclick = async () => {
  const pass = document.getElementById('adminPass').value.trim();
  if (!pass) return alert('请输入管理密码');
  try {
    const res = await fetch(WORKER_URL + '/getConfig', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({ pass })
    });
    if (!res.ok) throw new Error(await res.text() || 'HTTP ' + res.status);
    const json = await res.json();
    adapters = Array.isArray(json.adapters) ? json.adapters : [];
    
    if (json.CHANGENOW_API_KEY) {
      document.getElementById('api-key').value = json.CHANGENOW_API_KEY;
    }
    
    const networkAliasesJson = JSON.stringify(json.networkAliases || {}, null, 2);
    document.getElementById('network-aliases-json').value = networkAliasesJson;

    alert('配置加载成功');
    renderAdapters();
  } catch (err) {
    alert('加载失败：' + err.message);
  } finally {
    document.getElementById('adminPass').value = '';
  }
};

/**
 * 修正 4: 通用配置保存函数。
 * @param {boolean} onlyGlobal - true 表示只保存全局配置 (config)，忽略适配器。
 */
async function saveConfigWrapper(onlyGlobal) {
  const pass = document.getElementById(onlyGlobal ? 'admin-pass' : 'adminPass').value.trim();
  const verb = onlyGlobal ? '全局配置' : '配置 (含适配器)';
  
  if (!pass) return alert(`请输入管理密码进行 ${verb} 操作`);
  
  try {
    // 1. 获取并验证 Network Aliases
    const networkAliasesStr = document.getElementById('network-aliases-json').value.trim();
    let networkAliases = {};
    try {
        networkAliases = JSON.parse(networkAliasesStr);
        if (typeof networkAliases !== 'object' || Array.isArray(networkAliases)) throw new Error('不是有效的对象');
    } catch (e) {
        alert('网络别名映射 JSON 格式错误: ' + e.message);
        return; 
    }

    const globalConfig = { 
        CHANGENOW_API_KEY: document.getElementById('api-key').value.trim(),
        networkAliases: networkAliases
    };
    
    const payload = { pass, config: globalConfig };
    
    if (!onlyGlobal) {
        // 如果不是仅保存全局配置，则包含适配器列表
        // 注意：适配器中的 selected 和 isBatchAPI 字段会按原样保存
        payload.adapters = adapters.map(a => ({ ...a }));
    }

    const res = await fetch(WORKER_URL + '/saveConfig', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const txt = await res.text();
    if (!res.ok) throw new Error(txt || 'HTTP ' + res.status);
    alert(`${verb} 保存成功！`);
  } catch (err) {
    alert(`${verb} 保存失败：` + err.message);
  } finally {
    document.getElementById('adminPass').value = '';
    document.getElementById('admin-pass').value = '';
  }
};

// 绑定到按钮
document.getElementById('saveToKV').onclick = () => saveConfigWrapper(false);

document.getElementById('compare').onclick = async () => {
  // 修正 1: 将空字符串转换为 null，以便后端忽略这些参数
  const from = document.getElementById('from').value.trim().toUpperCase() || null;
  const to = document.getElementById('to').value.trim().toUpperCase() || null;
  const fromNetwork = document.getElementById('fromNetwork').value.trim().toUpperCase() || null;
  const toNetwork = document.getElementById('toNetwork').value.trim().toUpperCase() || null;
  const amount = Number(document.getElementById('amount').value.trim());
  
  // 基础校验
  if (!from || !to) return alert('请输入币种 From 和 To');
  if (isNaN(amount) || amount <= 0) return alert('数量必须是大于 0 的有效数字'); 

  queryPair = { 
    from: from, 
    to: to, 
    fromNetwork: fromNetwork, 
    toNetwork: toNetwork, 
    amount: amount 
  };

  const selectedMode = document.querySelector('input[name="mode"]:checked').value;
  
  // 【修改】功能 1: 过滤未选中的适配器
  const selectedAdapters = adapters.filter(a => a.selected !== false); 
  
  // 最终发送给 Worker 的适配器列表：既被选中，且汇率类型匹配
  const adaptersToSend = selectedAdapters.filter(a => (a.rateType || 'floating') === selectedMode);

  document.getElementById('status').textContent = '查询中...';
  document.getElementById('warnings').innerHTML = ''; // 清空警告区
  ['#floatingTable tbody', '#lockedTable tbody'].forEach(s => document.querySelector(s).innerHTML = '');
  ['#floatingSummary', '#lockedSummary'].forEach(s => document.querySelector(s).style.display = 'none');
  document.getElementById('copyJson').style.display = 'none';

  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), 15000);

  try {
    const requestBody = { 
      pair: queryPair, 
      adapters: adaptersToSend, // 发送过滤后的列表
    };

    const res = await fetch(WORKER_URL, {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      signal: controller.signal,
      body: JSON.stringify(requestBody)
    });

    if (!res.ok) {
      const txt = await res.text().catch(()=>null);
      throw new Error(txt || `HTTP ${res.status}`);
    }
    const results = await res.json();
    lastResults = results;
    showResults(results);
    
    // 修正 3: 显示警告信息
    const warnings = results.warnings || [];
    if (warnings.length > 0) {
        document.getElementById('warnings').innerHTML = warnings.map(w => {
            // 注意：w.adapter, w.message, w.error 必须在后端被 escapeHtml 才能保证 100% 安全
            return `<div class="warn-item">⚠️ [${w.adapter || '全局'}]: ${escapeHtml(w.message || w.error || 'Worker 日志警告')}</div>`;
        }).join('');
    }
    
    const total = Array.isArray(results.results) ? results.results.length : 0;
    document.getElementById('status').textContent = `完成，共 ${total} 条`;
    document.getElementById('copyJson').style.display = 'inline-block';
  } catch (e) {
    document.getElementById('status').textContent = e.name === 'AbortError' ? '请求超时' : '错误: ' + e.message;
  } finally {
    clearTimeout(timeout);
  }
};

document.getElementById('copyJson').onclick = () => {
  if (!lastResults) return alert('无数据');
  navigator.clipboard.writeText(JSON.stringify(lastResults, null, 2))
    .then(() => alert('已复制到剪贴板'))
    .catch(() => alert('复制失败'));
};


function showResults(results) {
  const floating = (results?.results || []).filter(r => r?.rateType === 'floating');
  const locked = (results?.results || []).filter(r => r?.rateType === 'locked');
  
  const sortFn = (a, b) => (b.outputAmount ?? -Infinity) - (a.outputAmount ?? -Infinity);
  
  floating.sort(sortFn);
  locked.sort(sortFn);
  
  renderTable(floating, '#floatingTable tbody');
  renderTable(locked, '#lockedTable tbody');
  
  renderSummary(floating.filter(r => r.ok), '#floatingSummary', floating[0]);
  renderSummary(locked.filter(r => r.ok), '#lockedSummary', locked[0]);
}

function renderTable(data, selector) {
  const tbody = document.querySelector(selector);
  tbody.innerHTML = '';
  if (!data.length) {
    tbody.innerHTML = '<tr><td colspan=3 style="text-align:center;color:#666;">无数据</td></tr>';
    return;
  }
  data.forEach((r, i) => {
    const best = i === 0 && r.ok && r.outputAmount != null;
    const outputDisplay = r.ok && r.outputAmount != null 
      ? Number(r.outputAmount).toFixed(6) + ' ' + queryPair.to 
      : `<span class="err">${escapeHtml(r.error || '失败')}</span>`;
      
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(r.name || '-')}${best ? '<span class="best-mark">Best</span>' : ''}</td>
      <td class="output-cell ${best ? 'best' : ''}" style="font-weight:${best ? 'bold' : 'normal'}; color:${best ? 'green' : 'inherit'};">
        ${outputDisplay}
      </td>
      <td>${r.ok && r.link && /^https?:\/\//i.test(r.link) ? `<a href="${escapeHtml(r.link)}" target="_blank" rel="noopener">前往</a>` : '-'}</td>
    `;
    tbody.appendChild(tr);
  });
}

function renderSummary(data, selector, bestResult) {
  const div = document.querySelector(selector);
  if (!data.length || !bestResult?.outputAmount) {
    div.style.display = 'none';
    return;
  }
  div.style.display = 'block';
  div.innerHTML = `
    <p>输入: <b>${queryPair.amount} ${queryPair.from}</b></p>
    <p>最优 (<b>${escapeHtml(bestResult.name)}</b>): 
       <b style="color:green; font-size: 1.2em;">${Number(bestResult.outputAmount).toFixed(6)} ${queryPair.to}</b>
    </p>
  `;
}
</script>
</body>
</html>
