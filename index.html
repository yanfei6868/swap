<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å³æ—¶å…‘æ¢æ±‡ç‡å¯¹æ¯”ï¼ˆå¤šé“¾ç‰ˆï¼‰ v20251128-FIXED</title>
<style>
/* ---- åŸå­ç±» ---- */
.b1{border:1px solid #ddd}.br4{border-radius:4px}.p4{padding:4px}.p8{padding:8px}.m6y{margin:6px 0}
.fs13{font-size:13px}.fs15{font-size:15px}.bgf5{background:#f5f5f5}.bgf9{background:#f9f9f9}
.w70{width:70px}.w90{width:90%}.flex{display:flex}.gap10{gap:10px}.fwrap{flex-wrap:wrap}
/* ---- ç»„ä»¶ ---- */
body{font-family:-apple-system,"Helvetica Neue",Arial,sans-serif;margin:12px;font-size:14px;line-height:1.5}
input,button,select,textarea{font-size:15px;padding:6px 8px;border-radius:4px;border:1px solid #ccc;box-sizing:border-box}
button{font-weight:500;background:#f8f9fa;border:1px solid #dee2e6;cursor:pointer}
button:hover{background:#e9ecef}
button:active{background:#dee2e6}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border-bottom:1px solid #dee2e6;padding:12px 8px;text-align:left}
th{background:#f8f9fa;font-weight:600}
.ok{color:#28a745}.err{color:#dc3545}.best-mark{color:#28a745;font-weight:bold;margin-left:6px}
.output-cell{font-size:1.05em}.output-cell.best{font-size:1.15em;font-weight:bold}
.warn-item{color:#fd7e14;font-weight:500;margin:8px 0}
.section-title{margin:24px 0 16px;border-bottom:2px solid #007bff;padding-bottom:8px;font-size:18px}
.config-area{border:1px solid #007bff;padding:16px;margin:20px 0;background:#f8f9ff;border-radius:8px}
.summary{margin:20px 0;padding:16px;border:1px solid #28a745;border-radius:8px;background:#d4edda}
.adapter-item{border:1px solid #e9ecef;padding:16px;margin:12px 0;border-radius:8px;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.05)}
.adapter-filter-list{margin:8px 0;padding:8px;border:1px dashed #dee2e6;background:#fff;max-height:240px;overflow-y:auto;border-radius:6px}
.adapter-filter-item{display:inline-block;padding:6px 12px;margin:4px;border:1px solid #d1d5db;border-radius:6px;cursor:pointer;font-size:13px;position:relative;padding-left:20px;transition:all .2s}
.adapter-filter-item:hover{background:#eff6ff;border-color:#3b82f6}
.adapter-filter-item.active{background:#ef4444;color:#fff;border-color:#ef4444;font-weight:600;box-shadow:0 0 8px rgba(239,68,68,.4)}
.adapter-filter-item.locked.active{background:#10b981;border-color:#10b981;box-shadow:0 0 8px rgba(16,185,129,.4)}
.adapter-filter-item.selected::before{content:'âœ…';position:absolute;left:2px;top:50%;transform:translateY(-50%) scale(.8);font-size:12px}
.collapsible{cursor:pointer;padding:10px 16px;width:100%;border:none;text-align:left;font-size:15px;background:#e5e7eb;margin:12px 0 0;border-radius:6px;font-weight:500}
.collapsible:hover{background:#d1d5db}
.content{padding:0 24px;max-height:0;overflow:hidden;transition:max-height .3s ease;background:#f8fafc;border-radius:0 0 6px 6px}
.content.active{padding:16px 24px 12px;max-height:1000px}
.import-box{border:2px dashed #10b981;padding:16px;margin:16px 0;border-radius:8px;background:#ecfdf5}
#importBtn{background:#10b981;color:#fff;font-weight:600;font-size:15px;padding:10px 20px;border:none;border-radius:6px}
#importBtn:hover{background:#059669}
.contact-area{border:1px solid #3b82f6;padding:16px;margin:24px 0;background:#eff6ff;border-radius:8px}
.contact-area ul{list-style:none;padding:0;margin:0}
.contact-area li{margin:6px 0}

/* --- ç²¾ç®€æ¨¡å¼ (Simple Mode) --- */
.simple-mode .pro-field{display:none !important}
.simple-mode .collapsible,.simple-mode .content{display:none !important}

/* --- æ ¸ååº”å †æ¨¡å¼ (Reactor Mode) --- */
.reactor-mode .reactor-field{display:block !important}
.reactor-mode .collapsible{display:block !important}
.reactor-mode .content{max-height:none !important;display:block !important}
.reactor-field{display:none}
/* é»˜è®¤éšè— */
</style>
</head>
<body>
<h1 style="color:#1f2937;margin-bottom:24px">ğŸš€ å³æ—¶å…‘æ¢æ±‡ç‡å¯¹æ¯”ï¼ˆå¤šé“¾ç‰ˆï¼‰ v20251128-FIXED</h1>

<!-- è¾“å…¥è¡¨å• -->
<div style="background:#f8fafc;padding:20px;border-radius:12px;margin-bottom:24px;border:1px solid #e2e8f0">
Â Â <div class="flex fwrap gap10" style="max-width:800px">
Â Â Â Â <label style="min-width:120px">å¸ç§ From: <input id="from" style="width:100px;font-weight:500" placeholder="USDT"></label>
Â Â Â Â <label style="min-width:120px">é“¾ From: <input id="fromNetwork" style="width:100px" placeholder="ETH"></label>
Â Â Â Â <label style="min-width:120px">å¸ç§ To: <input id="to" style="width:100px;font-weight:500" placeholder="USDC"></label>
Â Â Â Â <label style="min-width:120px">é“¾ To: <input id="toNetwork" style="width:100px" placeholder="ETH"></label>
Â Â Â Â <label style="min-width:120px">æ•°é‡: <input id="amount" type="number" step="0.01" min="0.01" style="width:100px" placeholder="1000" value="1000"></label>
Â Â </div>
Â Â 
Â Â <div style="margin-top:16px">
Â Â Â Â <label style="margin-left:12px;margin-right:8px"><input type="radio" name="mode" id="modeFloating" value="floating" checked> æŸ¥æµ®åŠ¨</label>
Â Â Â Â <label style="margin-right:16px"><input type="radio" name="mode" id="modeLocked" value="locked"> æŸ¥é”å®š</label>
Â Â Â Â <button id="compare" style="margin-left:8px;background:#3b82f6;color:white;font-weight:600;padding:10px 24px">ğŸš€ ä¸€é”®æ¯”ä»·</button>
Â Â Â Â <button id="copyJson" style="margin-left:8px;display:none;background:#6b7280;color:white;padding:10px 16px">ğŸ“‹ å¤åˆ¶ JSON</button>
Â Â </div>
</div>

<!-- æ¨¡å¼åˆ‡æ¢ -->
<div style="margin:24px 0;text-align:center">
Â Â <label id="modeLabel" style="background:#10b981;color:#fff;padding:12px 24px;border-radius:50px;cursor:pointer;font-size:16px;font-weight:600;display:inline-block;box-shadow:0 4px 12px rgba(16,185,129,.3)">
Â Â Â Â <input type="checkbox" id="proMode" style="display:none">
Â Â Â Â ğŸ‘¤ äººç±»å‹å¥½æ¨¡å¼ï¼ˆæç®€é…ç½®ï¼‰
Â Â </label>
</div>

<div id="status" class="fs13" style="margin:16px 0;padding:10px;background:#fef3c7;border:1px solid #f59e0b;border-radius:6px;color:#92400e">âš¡ å‡†å¤‡å°±ç»ªï¼Œè¯·è®¾ç½® WORKER_URL æˆ–åŠ è½½é…ç½®</div>
<div id="warnings" style="margin:16px 0"></div>

<!-- ç»“æœå±•ç¤º -->
<div style="margin:32px 0">
Â Â <h3 style="color:#3b82f6;margin-bottom:16px">ğŸ“ˆ æµ®åŠ¨æ±‡ç‡ç»“æœ</h3>
Â Â <table id="floatingTable">
Â Â Â Â <thead>
Â Â Â Â Â Â <tr>
Â Â Â Â Â Â Â Â <th style="width:280px">äº¤æ˜“æ‰€</th>
Â Â Â Â Â Â Â Â <th style="width:180px">é¢„ä¼°è¾“å‡ºé‡</th>
Â Â Â Â Â Â Â Â <th style="width:120px">æ“ä½œ</th>
Â Â Â Â Â Â </tr>
Â Â Â Â </thead>
Â Â Â Â <tbody></tbody>
Â Â </table>
Â Â <div id="floatingSummary" class="summary" style="display:none"></div>
</div>

<div style="margin:32px 0">
Â Â <h3 style="color:#10b981;margin-bottom:16px">ğŸ”’ é”å®šæ±‡ç‡ç»“æœ</h3>
Â Â <table id="lockedTable">
Â Â Â Â <thead>
Â Â Â Â Â Â <tr>
Â Â Â Â Â Â Â Â <th style="width:280px">äº¤æ˜“æ‰€</th>
Â Â Â Â Â Â Â Â <th style="width:180px">é¢„ä¼°è¾“å‡ºé‡</th>
Â Â Â Â Â Â Â Â <th style="width:120px">æ“ä½œ</th>
Â Â Â Â Â Â </tr>
Â Â Â Â </thead>
Â Â Â Â <tbody></tbody>
Â Â </table>
Â Â <div id="lockedSummary" class="summary" style="display:none"></div>
</div>

<!-- é…ç½®åŒºåŸŸ -->
<div class="config-area">
Â Â <h3 class="section-title">âš™ï¸ äº¤æ˜“æ‰€é€‚é…å™¨ç®¡ç†ï¼ˆéœ€å¯†ç ï¼‰</h3>
Â Â 
Â Â <div style="margin-bottom:16px">
Â Â Â Â <input id="adminPass" type="password" placeholder="ğŸ” è¾“å…¥ç®¡ç†å¯†ç " style="width:160px;padding:8px 12px">
Â Â Â Â <button id="loadFromKV" style="margin-left:12px;background:#10b981;color:white;padding:8px 16px">ğŸ“¥ ä»åç«¯åŠ è½½é…ç½®</button>
Â Â Â Â <button id="saveToKV" style="margin-left:8px;background:#3b82f6;color:white;padding:8px 16px">ğŸ’¾ ä¿å­˜åˆ°åç«¯</button>
Â Â </div>

Â Â <div style="margin:16px 0">
Â Â Â Â <button id="showAllAdapters" class="fs13" style="margin-bottom:12px;background:#6b7280;color:white;padding:6px 12px">ğŸ‘ï¸ æ˜¾ç¤ºå…¨éƒ¨é€‚é…å™¨</button>
Â Â Â Â 
Â Â Â Â <div class="b1 p4 br4" style="border-color:#3b82f6;margin-bottom:12px">
Â Â Â Â Â Â <div style="font-weight:600;color:#3b82f6;font-size:14px;padding-bottom:8px">ğŸ“Š æµ®åŠ¨æ±‡ç‡åˆ—è¡¨ (Floating)</div>
Â Â Â Â Â Â <div id="floatingAdapterList" class="adapter-filter-list"></div>
Â Â Â Â </div>

Â Â Â Â <div style="display:flex;gap:12px;margin:12px 0">
Â Â Â Â Â Â <button id="selectAllFloating" class="fs13" data-type="floating" style="background:#3b82f6;color:white;padding:6px 12px">âœ… å…¨é€‰æµ®åŠ¨</button>
Â Â Â Â Â Â <button id="deselectAllFloating" class="fs13" data-type="floating" style="background:#6b7280;color:white;padding:6px 12px">âŒ å…¨ä¸é€‰æµ®åŠ¨</button>
Â Â Â Â </div>

Â Â Â Â <div class="b1 p4 br4" style="border-color:#10b981">
Â Â Â Â Â Â <div style="font-weight:600;color:#10b981;font-size:14px;padding-bottom:8px">ğŸ”’ é”å®šæ±‡ç‡åˆ—è¡¨ (Locked)</div>
Â Â Â Â Â Â <div id="lockedAdapterList" class="adapter-filter-list"></div>
Â Â Â Â </div>

Â Â Â Â <div style="display:flex;gap:12px;margin:12px 0">
Â Â Â Â Â Â <button id="selectAllLocked" class="fs13" data-type="locked" style="background:#10b981;color:white;padding:6px 12px">âœ… å…¨é€‰é”å®š</button>
Â Â Â Â Â Â <button id="deselectAllLocked" class="fs13" data-type="locked" style="background:#6b7280;color:white;padding:6px 12px">âŒ å…¨ä¸é€‰é”å®š</button>
Â Â Â Â </div>
Â Â </div>

Â Â <div style="margin:16px 0;font-size:14px;color:#6b7280">
Â Â Â Â ğŸ’¡ å¯æ·»åŠ æˆ–åˆ é™¤è‡ªå®šä¹‰äº¤æ˜“æ‰€ APIã€‚é…ç½®å°†ä¿å­˜åˆ° Cloudflare Worker KV ä¸­ã€‚
Â Â </div>
Â Â 
Â Â <button id="addAdapter" style="margin:12px 0;background:#10b981;color:white;padding:10px 20px;font-weight:600">â• æ–°å¢äº¤æ˜“æ‰€</button>

Â Â <!-- å¯¼å…¥åŒºåŸŸ -->
Â Â <div class="import-box">
Â Â Â Â <button id="importBtn">ğŸ“¦ ä¸€é”®å¯¼å…¥/è¦†ç›–é€‚é…å™¨</button>
Â Â Â Â <textarea id="importJson" placeholder="ç²˜è´´å®Œæ•´é€‚é…å™¨ JSON è¿™é‡Œï¼Œä¸€é”®å¯¼å…¥å³å¯è¦†ç›–åŒåé€‚é…å™¨" rows="4" style="width:100%;margin-top:12px;padding:12px;border:1px solid #d1d5db;border-radius:6px;font-family:monospace;font-size:13px"></textarea>
Â Â </div>

Â Â <!-- é€‚é…å™¨è¯¦æƒ… -->
Â Â <div id="adapterList"></div>
</div>

<!-- å…¨å±€é…ç½® -->
<div class="config-area">
Â Â <h3 class="section-title">ğŸŒ å…¨å±€ç½‘ç»œåˆ«åæ˜ å°„</h3>
Â Â <label style="display:block;margin-bottom:12px;font-weight:500">
Â Â Â Â NETWORK_ALIASES JSON é…ç½®:
Â Â </label>
Â Â <textarea id="network-aliases-json" style="width:100%;height:140px;font-family:monospace;font-size:13px;padding:12px;border:1px solid #d1d5db;border-radius:6px">{
Â Â "BTC": "BITCOIN",
Â Â "ETH": "ETHEREUM", 
Â Â "TRX": "TRON",
Â Â "BNB": "BSC",
Â Â "SOL": "SOLANA",
Â Â "MAINNET": "BITCOIN",
Â Â "ARBITRUM": "ARBITRUM_ONE"
}</textarea>
</div>

<!-- è”ç³»ä¿¡æ¯ -->
<div class="contact-area">
Â Â <h4 class="section-title" style="margin-top:0;border-bottom:none;color:#1f2937">ğŸ“§ è”ç³»ä½œè€…</h4>
Â Â <p style="margin:8px 0;color:#374151">æœ‰å»ºè®® / åˆä½œ / é—®é¢˜ï¼Ÿ</p>
Â Â <p>
Â Â Â Â <a id="mail" href="#" style="color:#3b82f6;font-weight:500;font-size:15px"></a><br>
Â Â Â Â <a href="https://github.com/yourname/your-repo" target="_blank" rel="noopener" style="color:#6b7280">ğŸ™ GitHub ä»“åº“</a>
Â Â </p>
</div>

<script>
/* ---------- é…ç½® ---------- */
const WORKER_URL = 'https://winter-dust-5610.yanfei6868.workers.dev'; // è¯·ä¿®æ”¹ä¸ºå®é™…Workeråœ°å€
let currentAdapters = [], queryPair = {}, lastResults = null, visibleAdapterIndex = 'all';

/* ---------- å·¥å…·å‡½æ•° ---------- */
const escapeHtml = s => s == null ? '' : String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
const byId = id => document.getElementById(id);
const qs = (sel, ctx = document) => ctx.querySelector(sel);
const qsa = (sel, ctx = document) => [...ctx.querySelectorAll(sel)];

/* ---------- æ¸²æŸ“æ±‡ç‡è¡¨ ---------- */
function buildRateRows(data, bestIdx = 0){
Â Â return data.map((r,i) => {
Â Â Â Â const best = i === bestIdx && r.ok && r.outputAmount != null;
Â Â Â Â const out = r.ok && r.outputAmount != null 
Â Â Â Â Â Â ? `<span class="ok">${Number(r.outputAmount).toFixed(6)} ${escapeHtml(queryPair.to || '')}</span>`
Â Â Â Â Â Â : `<span class="err">${escapeHtml(r.error || 'è¯·æ±‚å¤±è´¥')}</span>`;
Â Â Â Â const link = r.ok && r.link && /^https?:\/\//i.test(r.link) 
Â Â Â Â Â Â ? `<a href="${escapeHtml(r.link)}" target="_blank" rel="noopener" style="color:#3b82f6">ğŸš€ å‰å¾€äº¤æ˜“</a>`
Â Â Â Â Â Â : 'â€”';
Â Â Â Â return `
Â Â Â Â Â Â <tr>
Â Â Â Â Â Â Â Â <td style="font-weight:${best ? 'bold' : 'normal'}">
Â Â Â Â Â Â Â Â Â Â ${escapeHtml(r.name || 'æœªçŸ¥äº¤æ˜“æ‰€')}${best ? '<span class="best-mark">â­ æœ€ä¼˜</span>' : ''}
Â Â Â Â Â Â Â Â </td>
Â Â Â Â Â Â Â Â <td class="output-cell ${best ? 'best' : ''}" style="font-weight:${best ? 'bold' : 'normal'};color:${best ? '#10b981' : 'inherit'}">
Â Â Â Â Â Â Â Â Â Â ${out}
Â Â Â Â Â Â Â Â </td>
Â Â Â Â Â Â Â Â <td>${link}</td>
Â Â Â Â Â Â </tr>
Â Â Â Â `;
Â Â }).join('');
}

/* ---------- é€‚é…å™¨æ ‡ç­¾åˆ—è¡¨ ---------- */
function renderAdapterFilterList(){
Â Â const floatingList = byId('floatingAdapterList'), lockedList = byId('lockedAdapterList');
Â Â floatingList.innerHTML = lockedList.innerHTML = '';
Â Â 
Â Â currentAdapters.forEach((a,i) => {
Â Â Â Â const item = document.createElement('span');
Â Â Â Â item.className = `adapter-filter-item ${a.rateType === 'locked' ? 'locked' : ''} ${a.selected === false ? '' : 'selected'} ${i === visibleAdapterIndex ? 'active' : ''}`;
Â Â Â Â item.dataset.index = i;
Â Â Â Â item.innerHTML = `
Â Â Â Â Â Â <span style="opacity:${i === visibleAdapterIndex ? 1 : 0};margin-right:6px;transition:opacity .2s">[#${i+1}]</span>
Â Â Â Â Â Â ${escapeHtml(a.name || 'æœªå‘½å')}
Â Â Â Â `;
Â Â Â Â item.onmouseover = () => item.firstElementChild.style.opacity = 1;
Â Â Â Â item.onmouseout = () => { if (i !== visibleAdapterIndex) item.firstElementChild.style.opacity = 0; };
Â Â Â Â item.onclick = () => showAdapter(i);
Â Â Â Â 
Â Â Â Â const list = a.rateType === 'floating' ? floatingList : lockedList;
Â Â Â Â list.appendChild(item);
Â Â });
}

/* ---------- æ¸²æŸ“é€‚é…å™¨é…ç½® ---------- */
function renderAdapters(){
Â Â const container = byId('adapterList');
Â Â container.innerHTML = '';
Â Â 
Â Â currentAdapters.forEach((a,i) => {
Â Â Â Â const div = document.createElement('div');
Â Â Â Â div.className = 'adapter-item';
Â Â Â Â div.dataset.index = i;
Â Â Â Â if (visibleAdapterIndex !== i && visibleAdapterIndex !== 'all') div.style.display = 'none';

Â Â Â Â // ç”Ÿæˆé»˜è®¤å€¼
Â Â Â Â const authType = a.auth?.type || 'header';
Â Â Â Â const authName = a.auth?.name || '';
Â Â Â Â const timeoutMs = a.timeoutMs || 15000;
Â Â Â Â const bodyCt = a.bodyContentType || 'json';
Â Â Â Â const ppHeader = a.postProcess?.headers ? JSON.stringify(a.postProcess.headers, null, 2) : '';
Â Â Â Â const ppQuery = a.postProcess?.query ? JSON.stringify(a.postProcess.query, null, 2) : '';
Â Â Â Â const ppBody = a.postProcess?.body ? JSON.stringify(a.postProcess.body, null, 2) : '';
Â Â Â Â const customJs = a.customJs || '';

Â Â Â Â div.innerHTML = `
Â Â Â Â Â Â <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
Â Â Â Â Â Â Â Â <div style="font-size:16px;font-weight:600;color:#1f2937">
Â Â Â Â Â Â Â Â Â Â [#${i+1}] ${escapeHtml(a.name || `é€‚é…å™¨${i+1}`)}
Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â Â Â <label style="display:flex;align-items:center;gap:6px">
Â Â Â Â Â Â Â Â Â Â <input type="checkbox" class="adapter-selector" data-i="${i}" ${a.selected !== false ? 'checked' : ''}>
Â Â Â Â Â Â Â Â Â Â <span style="font-weight:500;color:#6b7280">æ¯”ä»·é€‰ä¸­</span>
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â </div>
Â Â Â Â Â Â 
Â Â Â Â Â Â <div class="small" style="margin-bottom:16px">
Â Â Â Â Â Â Â Â <label style="display:block;margin-bottom:6px;font-weight:500">ğŸ“ æ˜¾ç¤ºåç§°</label>
Â Â Â Â Â Â Â Â <input data-i="${i}" class="name w90" value="${escapeHtml(a.name || '')}" placeholder="äº¤æ˜“æ‰€æ˜¾ç¤ºåç§°">
Â Â Â Â Â Â </div>
Â Â Â Â Â Â 
Â Â Â Â Â Â <div class="small" style="margin-bottom:16px">
Â Â Â Â Â Â Â Â <label style="display:block;margin-bottom:6px;font-weight:500">ğŸŒ URLæ¨¡æ¿</label>
Â Â Â Â Â Â Â Â <input data-i="${i}" class="urlTemplate w90" value="${escapeHtml(a.urlTemplate || '')}" placeholder="æ”¯æŒ {{from}}, {{to}}, {{amount}} ç­‰å˜é‡">
Â Â Â Â Â Â </div>
Â Â Â Â Â Â 
Â Â Â Â Â Â <div class="small pro-field" style="margin-bottom:16px">
Â Â Â Â Â Â Â Â <label style="display:block;margin-bottom:6px;font-weight:500">ğŸ”— é“¾æ¥æ¨¡æ¿</label>
Â Â Â Â Â Â Â Â <input data-i="${i}" class="linkTemplate w90" value="${escapeHtml(a.linkTemplate || '')}" placeholder="äº¤æ˜“è·³è½¬é“¾æ¥">
Â Â Â Â Â Â </div>

Â Â Â Â Â Â <div class="small flex fwrap gap10" style="border:1px dashed #d1d5db;padding:16px;margin:16px 0;border-radius:8px;background:#f8fafc">
Â Â Â Â Â Â Â Â <label style="flex:1;min-width:120px">
Â Â Â Â Â Â Â Â Â Â <span style="display:block;margin-bottom:4px;font-weight:500">ğŸ“¡ è¯·æ±‚æ–¹æ³•</span>
Â Â Â Â Â Â Â Â Â Â <select data-i="${i}" class="method">
Â Â Â Â Â Â Â Â Â Â Â Â <option value="GET" ${a.method === 'GET' ? 'selected' : ''}>GET</option>
Â Â Â Â Â Â Â Â Â Â Â Â <option value="POST" ${a.method === 'POST' ? 'selected' : ''}>POST</option>
Â Â Â Â Â Â Â Â Â Â </select>
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â Â Â <label style="flex:1;min-width:120px">
Â Â Â Â Â Â Â Â Â Â <span style="display:block;margin-bottom:4px;font-weight:500">ğŸ·ï¸ æ±‡ç‡ç±»å‹</span>
Â Â Â Â Â Â Â Â Â Â <select data-i="${i}" class="rateType">
Â Â Â Â Â Â Â Â Â Â Â Â <option value="floating" ${a.rateType === 'floating' ? 'selected' : ''}>æµ®åŠ¨ Floating</option>
Â Â Â Â Â Â Â Â Â Â Â Â <option value="fixed" ${a.rateType === 'fixed' ? 'selected' : ''}>å›ºå®š Fixed</option>
Â Â Â Â Â Â Â Â Â Â Â Â <option value="locked" ${a.rateType === 'locked' ? 'selected' : ''}>é”å®š Locked</option>
Â Â Â Â Â Â Â Â Â Â </select>
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â Â Â <label style="flex:1;min-width:120px">
Â Â Â Â Â Â Â Â Â Â <span style="display:block;margin-bottom:4px;font-weight:500">ğŸ” è§£æç±»å‹</span>
Â Â Â Â Â Â Â Â Â Â <select data-i="${i}" class="parseType">
Â Â Â Â Â Â Â Â Â Â Â Â <option value="json" ${a.parseType === 'json' ? 'selected' : ''}>JSON</option>
Â Â Â Â Â Â Â Â Â Â Â Â <option value="html_regex" ${a.parseType === 'html_regex' ? 'selected' : ''}>HTML/Regex</option>
Â Â Â Â Â Â Â Â Â Â </select>
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â </div>

Â Â Â Â Â Â <div class="small pro-field flex fwrap gap10" style="border:1px dashed #d1d5db;padding:12px;margin:12px 0;border-radius:8px;background:#f8fafc">
Â Â Â Â Â Â Â Â <label style="flex:1;min-width:140px">
Â Â Â Â Â Â Â Â Â Â <span style="display:block;margin-bottom:4px;font-weight:500">ğŸ’° è§£æç»“æœ</span>
Â Â Â Â Â Â Â Â Â Â <select data-i="${i}" class="parseResultAs">
Â Â Â Â Â Â Â Â Â Â Â Â <option value="total" ${a.parseResultAs === 'total' ? 'selected' : ''}>æ€»é‡‘é¢ Total</option>
Â Â Â Â Â Â Â Â Â Â Â Â <option value="rate" ${a.parseResultAs === 'rate' ? 'selected' : ''}>æ±‡ç‡ Rate</option>
Â Â Â Â Â Â Â Â Â Â </select>
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â Â Â <label style="flex:1;min-width:100px">
Â Â Â Â Â Â Â Â Â Â <span style="display:block;margin-bottom:4px;font-weight:500">âš¡ æ‰¹å¤„ç†</span>
Â Â Â Â Â Â Â Â Â Â <select data-i="${i}" class="isBatchAPI">
Â Â Â Â Â Â Â Â Â Â Â Â <option value="true" ${a.isBatchAPI !== false ? 'selected' : ''}>æ˜¯ (é»˜è®¤)</option>
Â Â Â Â Â Â Â Â Â Â Â Â <option value="false" ${a.isBatchAPI === false ? 'selected' : ''}>å¦</option>
Â Â Â Â Â Â Â Â Â Â </select>
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â Â Â <label style="flex:1;min-width:120px">
Â Â Â Â Â Â Â Â Â Â <span style="display:block;margin-bottom:4px;font-weight:500">â±ï¸ è¶…æ—¶(ms)</span>
Â Â Â Â Â Â Â Â Â Â <input type="number" data-i="${i}" class="timeoutMs w70" value="${escapeHtml(timeoutMs)}" min="1000" max="60000">
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â </div>

Â Â Â Â Â Â <div class="small pro-field" style="margin:12px 0">
Â Â Â Â Â Â Â Â <label style="display:block;margin-bottom:6px;font-weight:500">ğŸ“‹ HTTP Headers</label>
Â Â Â Â Â Â Â Â <textarea data-i="${i}" class="headers w90" rows="3" placeholder='{"Authorization": "Bearer xxx", "Content-Type": "application/json"}'>${escapeHtml(a.headers ? JSON.stringify(a.headers, null, 2) : '')}</textarea>
Â Â Â Â Â Â </div>

Â Â Â Â Â Â <div class="small pro-field" style="margin:12px 0">
Â Â Â Â Â Â Â Â <label style="display:block;margin-bottom:6px;font-weight:500">ğŸ“„ Body Content Type</label>
Â Â Â Â Â Â Â Â <select data-i="${i}" class="bodyContentType">
Â Â Â Â Â Â Â Â Â Â <option value="json" ${bodyCt === 'json' ? 'selected' : ''}>JSON</option>
Â Â Â Â Â Â Â Â Â Â <option value="form" ${bodyCt === 'form' ? 'selected' : ''}>Form</option>
Â Â Â Â Â Â Â Â Â Â <option value="raw" ${bodyCt === 'raw' ? 'selected' : ''}>Raw</option>
Â Â Â Â Â Â Â Â </select>
Â Â Â Â Â Â </div>

Â Â Â Â Â Â <div class="small pro-field" style="margin:12px 0">
Â Â Â Â Â Â Â Â <label style="display:block;margin-bottom:6px;font-weight:500">ğŸ“¦ Body</label>
Â Â Â Â Â Â Â Â <textarea data-i="${i}" class="body w90" rows="4" placeholder='{"from": "{{from}}", "to": "{{to}}", "amount": {{amount}} }'>${escapeHtml(typeof a.body === 'object' ? JSON.stringify(a.body, null, 2) : (a.body || ''))}</textarea>
Â Â Â Â Â Â </div>

Â Â Â Â Â Â <div class="small pro-field" style="margin:12px 0">
Â Â Â Â Â Â Â Â <label style="display:block;margin-bottom:6px;font-weight:500">ğŸ”„ å¸ç§/é“¾åæ˜ å°„</label>
Â Â Â Â Â Â Â Â <textarea data-i="${i}" class="mappings w90" rows="4" placeholder='{"USDT": "Tether", "USDC": "USD Coin"}'>${escapeHtml(a.mappings ? JSON.stringify(a.mappings, null, 2) : '')}</textarea>
Â Â Â Â Â Â </div>
Â Â Â Â Â Â 
Â Â Â Â Â Â <div class="small reactor-field" style="margin:12px 0">
Â Â Â Â Â Â Â Â <label style="display:block;margin-bottom:6px;font-weight:500">âš¡ è¯·æ±‚å‰è„šæœ¬ (customJs)</label>
Â Â Â Â Â Â Â Â <textarea data-i="${i}" class="customJs w90" rows="4" placeholder='function beforeRequest(config) {\nÂ Â // ä¿®æ”¹è¯·æ±‚é…ç½®\nÂ Â return config;\n}'>${escapeHtml(customJs)}</textarea>
Â Â Â Â Â Â </div>

Â Â Â Â Â Â <div class="small" style="border:1px solid #d1d5db;padding:16px;border-radius:8px;margin:16px 0;background:#f8fafc">
Â Â Â Â Â Â Â Â <label style="display:block;margin-bottom:8px;font-weight:500">ğŸ”‘ API Key</label>
Â Â Â Â Â Â Â Â <input data-i="${i}" class="apiKey w90" value="${escapeHtml(a.apiKey || '')}" placeholder="è¾“å…¥APIå¯†é’¥" type="password">
Â Â Â Â Â Â Â Â <div class="flex gap10" style="margin-top:12px">
Â Â Â Â Â Â Â Â Â Â <label style="flex:1">
Â Â Â Â Â Â Â Â Â Â Â Â <span style="display:block;margin-bottom:4px;font-weight:500">ä½ç½®</span>
Â Â Â Â Â Â Â Â Â Â Â Â <select data-i="${i}" class="authType">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â <option value="header" ${authType === 'header' ? 'selected' : ''}>Header</option>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â <option value="query" ${authType === 'query' ? 'selected' : ''}>Query</option>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â <option value="">æ— </option>
Â Â Â Â Â Â Â Â Â Â Â Â </select>
Â Â Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â Â Â Â Â <label style="flex:2">
Â Â Â Â Â Â Â Â Â Â Â Â <span style="display:block;margin-bottom:4px;font-weight:500">åç§°</span>
Â Â Â Â Â Â Â Â Â Â Â Â <input data-i="${i}" class="authName" value="${escapeHtml(authName)}" placeholder="å¦‚ X-API-Key">
Â Â Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â </div>

Â Â Â Â Â Â <button type="button" class="collapsible pro-field" data-target="adv-${i}" style="background:#6b7280;color:white">
Â Â Â Â Â Â Â Â âš™ï¸ é«˜çº§è®¾ç½®
Â Â Â Â Â Â </button>
Â Â Â Â Â Â <div class="content pro-field" id="adv-${i}">
Â Â Â Â Â Â Â Â <div style="margin-bottom:16px;padding:12px;background:#fef3c7;border:1px solid #f59e0b;border-radius:6px">
Â Â Â Â Â Â Â Â Â Â <strong>ğŸ”§ åç½®å¤„ç† (JSON)</strong>
Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â Â Â <div class="flex fwrap gap10" style="margin-bottom:16px">
Â Â Â Â Â Â Â Â Â Â <div style="flex:1">
Â Â Â Â Â Â Â Â Â Â Â Â <label style="display:block;margin-bottom:6px;font-weight:500">åç½® Header</label>
Â Â Â Â Â Â Â Â Â Â Â Â <textarea data-i="${i}" class="ppHeader w90" rows="3" placeholder='{"X-Custom": "value"}'>${escapeHtml(ppHeader)}</textarea>
Â Â Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â Â Â Â Â <div style="flex:1">
Â Â Â Â Â Â Â Â Â Â Â Â <label style="display:block;margin-bottom:6px;font-weight:500">åç½® Query</label>
Â Â Â Â Â Â Â Â Â Â Â Â <textarea data-i="${i}" class="ppQuery w90" rows="3" placeholder='{"param": "value"}'>${escapeHtml(ppQuery)}</textarea>
Â Â Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â Â Â Â Â <div style="flex:1">
Â Â Â Â Â Â Â Â Â Â Â Â <label style="display:block;margin-bottom:6px;font-weight:500">åç½® Body</label>
Â Â Â Â Â Â Â Â Â Â Â Â <textarea data-i="${i}" class="ppBody w90" rows="3" placeholder='{"key": "value"}'>${escapeHtml(ppBody)}</textarea>
Â Â Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â <div class="flex fwrap gap10" style="margin-bottom:16px">
Â Â Â Â Â Â Â Â Â Â <div style="flex:1">
Â Â Â Â Â Â Â Â Â Â Â Â <label style="display:block;margin-bottom:6px;font-weight:500">ğŸ“ Parse Path</label>
Â Â Â Â Â Â Â Â Â Â Â Â <input data-i="${i}" class="parsePath w90" value="${escapeHtml(a.parsePath || '')}" placeholder="JSON Path æˆ– Regex">
Â Â Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â Â Â Â Â <div style="flex:1">
Â Â Â Â Â Â Â Â Â Â Â Â <label style="display:block;margin-bottom:6px;font-weight:500">âœ… æˆåŠŸçŠ¶æ€ç </label>
Â Â Â Â Â Â Â Â Â Â Â Â <input data-i="${i}" class="successStatus w90" value="${escapeHtml(Array.isArray(a.successStatus) ? a.successStatus.join(',') : '200,201,204')}" placeholder="200,201,204">
Â Â Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â <div class="flex fwrap gap10" style="margin-bottom:16px">
Â Â Â Â Â Â Â Â Â Â <div style="flex:1">
Â Â Â Â Â Â Â Â Â Â Â Â <label style="display:block;margin-bottom:6px;font-weight:500">ğŸ’µ é»˜è®¤é‡‘é¢è·¯å¾„</label>
Â Â Â Â Â Â Â Â Â Â Â Â <input data-i="${i}" class="defaultAmountPaths w90" value="${escapeHtml(Array.isArray(a.defaultAmountPaths) ? a.defaultAmountPaths.join(',') : 'estimatedAmount,toAmount')}" placeholder="estimatedAmount,toAmount">
Â Â Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â Â Â Â Â <div style="flex:1">
Â Â Â Â Â Â Â Â Â Â Â Â <label style="display:block;margin-bottom:6px;font-weight:500">ğŸ“„ Content Type</label>
Â Â Â Â Â Â Â Â Â Â Â Â <input data-i="${i}" class="contentTypeMap w90" value="${escapeHtml(Array.isArray(a.contentTypeMap) ? a.contentTypeMap.join(',') : 'application/json,text/html')}" placeholder="application/json,text/html">
Â Â Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â <div style="margin-top:12px">
Â Â Â Â Â Â Â Â Â Â <label style="display:flex;align-items:center;gap:8px">
Â Â Â Â Â Â Â Â Â Â Â Â <input type="checkbox" data-i="${i}" class="allowNoVars" ${a.allowNoVars === true ? 'checked' : ''}>
Â Â Â Â Â Â Â Â Â Â Â Â <span style="font-weight:500">âœ… å…è®¸ä¸ä½¿ç”¨å˜é‡ (å…è®¸é™æ€URL)</span>
Â Â Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â </div>

Â Â Â Â Â Â <button data-i="${i}" class="del" style="background:#dc3545;color:white;padding:8px 16px;border:none;border-radius:6px;font-weight:500;margin-top:16px">ğŸ—‘ï¸ åˆ é™¤</button>
Â Â Â Â `;
Â Â Â Â container.appendChild(div);
Â Â });

Â Â // äº‹ä»¶å§”æ‰˜
Â Â container.onchange = e => {
Â Â Â Â const i = +e.target.dataset.i, p = e.target.classList[0];
Â Â Â Â if (!p || !Number.isFinite(i)) return;
Â Â Â Â let v = e.target.value.trim();
Â Â Â Â const isCheckbox = e.target.type === 'checkbox';

Â Â Â Â // å¤„ç† adapter-selector
Â Â Â Â if (e.target.classList.contains('adapter-selector')) {
Â Â Â Â Â Â if (!e.target.checked) {
Â Â Â Â Â Â Â Â currentAdapters[i].selected = false;
Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â delete currentAdapters[i].selected;
Â Â Â Â Â Â }
Â Â Â Â Â Â renderAdapterFilterList();
Â Â Â Â }

Â Â Â Â // å¤„ç† allowNoVars å¤é€‰æ¡†
Â Â Â Â if (p === 'allowNoVars' && isCheckbox) {
Â Â Â Â Â Â const checked = e.target.checked;
Â Â Â Â Â Â if (checked) {
Â Â Â Â Â Â Â Â currentAdapters[i][p] = true;
Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â delete currentAdapters[i][p];
Â Â Â Â Â Â }
Â Â Â Â Â Â return;
Â Â Â Â }

Â Â Â Â // customJs å…è®¸ç©ºå­—ç¬¦ä¸²
Â Â Â Â if (p === 'customJs' && v === '') {
Â Â Â Â Â Â delete currentAdapters[i][p];
Â Â Â Â }
Â Â Â Â // JSON å­—æ®µå¤„ç†
Â Â Â Â else if (['mappings', 'headers', 'body', 'ppHeader', 'ppQuery', 'ppBody'].includes(p)) {
Â Â Â Â Â Â try {
Â Â Â Â Â Â Â Â v = v ? JSON.parse(v) : null;
Â Â Â Â Â Â } catch {
Â Â Â Â Â Â Â Â alert(`${p} JSON æ ¼å¼é”™è¯¯`);
Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â }
Â Â Â Â }
Â Â Â Â 
Â Â Â Â if (p === 'timeoutMs') v = Number(v) || 15000;

Â Â Â Â // æ•°ç»„å­—æ®µå¤„ç†
Â Â Â Â if (['successStatus', 'defaultAmountPaths', 'contentTypeMap'].includes(p)) {
Â Â Â Â Â Â v = v ? v.split(',').map(s => s.trim()).filter(Boolean) : null;
Â Â Â Â }

Â Â Â Â // isBatchAPI å¤„ç†
Â Â Â Â if (p === 'isBatchAPI') {
Â Â Â Â Â Â if (v === 'true') {
Â Â Â Â Â Â Â Â delete currentAdapters[i][p]; // é»˜è®¤å€¼
Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â currentAdapters[i][p] = false;
Â Â Â Â Â Â }
Â Â Â Â Â Â renderAdapterFilterList();
Â Â Â Â Â Â return;
Â Â Â Â }

Â Â Â Â // åç½®å¤„ç†
Â Â Â Â if (p.startsWith('pp')) {
Â Â Â Â Â Â currentAdapters[i].postProcess = currentAdapters[i].postProcess || {};
Â Â Â Â Â Â const key = p.slice(2).toLowerCase();
Â Â Â Â Â Â currentAdapters[i].postProcess[key] = v;
Â Â Â Â Â Â if (v === null) delete currentAdapters[i].postProcess[key];
Â Â Â Â Â Â if (Object.keys(currentAdapters[i].postProcess).length === 0) delete currentAdapters[i].postProcess;
Â Â Â Â } else {
Â Â Â Â Â Â if (p !== 'adapter-selector') {
Â Â Â Â Â Â Â Â if ((v === null || v === '') && p !== 'name') {
Â Â Â Â Â Â Â Â Â Â delete currentAdapters[i][p];
Â Â Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â Â Â currentAdapters[i][p] = v;
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â }
Â Â Â Â }

Â Â Â Â // è§¦å‘é‡ç»˜
Â Â Â Â if (p === 'name' || p === 'adapter-selector') renderAdapterFilterList();
Â Â Â Â if (p === 'rateType' || p === 'parseType') renderAdapters();
Â Â };

Â Â container.onclick = e => {
Â Â Â Â if (e.target.classList.contains('del')) {
Â Â Â Â Â Â if (confirm(`ç¡®è®¤åˆ é™¤é€‚é…å™¨ "${currentAdapters[+e.target.dataset.i]?.name || 'æœªå‘½å'}"?`)) {
Â Â Â Â Â Â Â Â currentAdapters.splice(+e.target.dataset.i, 1);
Â Â Â Â Â Â Â Â visibleAdapterIndex = 'all';
Â Â Â Â Â Â Â Â renderAdapters();
Â Â Â Â Â Â }
Â Â Â Â }
Â Â Â Â if (e.target.classList.contains('collapsible')) {
Â Â Â Â Â Â e.target.classList.toggle('active');
Â Â Â Â Â Â const cnt = byId(e.target.dataset.target);
Â Â Â Â Â Â cnt.classList.toggle('active');
Â Â Â Â Â Â if (document.body.classList.contains('reactor-mode')) {
Â Â Â Â Â Â Â Â cnt.style.maxHeight = 'none';
Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â cnt.style.maxHeight = cnt.classList.contains('active') ? cnt.scrollHeight + 'px' : null;
Â Â Â Â Â Â }
Â Â Â Â }
Â Â };

Â Â renderAdapterFilterList();
Â Â if (visibleAdapterIndex !== null && visibleAdapterIndex !== 'all') {
Â Â Â Â const target = container.querySelector(`[data-index="${visibleAdapterIndex}"]`);
Â Â Â Â if (target) target.scrollIntoView({ block: 'start', behavior: 'smooth' });
Â Â }
}

/* ---------- äº¤äº’å‡½æ•° ---------- */
function showAdapter(idx) {
Â Â visibleAdapterIndex = idx;
Â Â qsa('#adapterList .adapter-item').forEach(d => d.style.display = +d.dataset.index === idx ? 'block' : 'none');
Â Â renderAdapterFilterList();
Â Â const tgt = qs(`[data-index="${idx}"]`, byId('adapterList'));
Â Â if (tgt) tgt.scrollIntoView({ block: 'start', behavior: 'smooth' });
}

// æ˜¾ç¤ºå…¨éƒ¨é€‚é…å™¨
byId('showAllAdapters').onclick = () => {
Â Â visibleAdapterIndex = 'all';
Â Â renderAdapters();
};

// æ–°å¢é€‚é…å™¨
byId('addAdapter').onclick = () => {
Â Â currentAdapters.unshift({
Â Â Â Â name: 'æ–°äº¤æ˜“æ‰€',
Â Â Â Â urlTemplate: '',
Â Â Â Â method: 'GET',
Â Â Â Â parseType: 'json',
Â Â Â Â parsePath: '',
Â Â Â Â parseResultAs: 'total',
Â Â Â Â rateType: 'floating',
Â Â Â Â timeoutMs: 15000,
Â Â Â Â bodyContentType: 'json',
Â Â Â Â successStatus: [200, 201, 204],
Â Â Â Â defaultAmountPaths: ['estimatedAmount', 'toAmount'],
Â Â Â Â contentTypeMap: ['application/json', 'text/html'],
Â Â Â Â isBatchAPI: true // é»˜è®¤å€¼
Â Â });
Â Â visibleAdapterIndex = 0;
Â Â renderAdapters();
};

/* ---------- æ‰¹é‡é€‰æ‹© ---------- */
function batchSelect(rateType, selectState) {
Â Â currentAdapters.forEach((a) => {
Â Â Â Â if (a.rateType === rateType) {
Â Â Â Â Â Â if (selectState) {
Â Â Â Â Â Â Â Â delete a.selected; // é€‰ä¸­æ—¶åˆ é™¤å­—æ®µ (é»˜è®¤é€‰ä¸­)
Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â a.selected = false; // å–æ¶ˆé€‰ä¸­æ—¶è®¾ä¸º false
Â Â Â Â Â Â }
Â Â Â Â }
Â Â });
Â Â renderAdapterFilterList();

Â Â // çŠ¶æ€åé¦ˆ
Â Â const count = currentAdapters.filter(a => a.rateType === rateType && a.selected !== false).length;
Â Â const total = currentAdapters.filter(a => a.rateType === rateType).length;
Â Â byId('status').textContent = `âœ… ${selectState ? 'å…¨é€‰' : 'å…¨ä¸é€‰'} ${rateType === 'floating' ? 'æµ®åŠ¨' : 'é”å®š'}æ±‡ç‡ (${count}/${total})`;
}

// æ‰¹é‡é€‰æ‹©äº‹ä»¶
document.addEventListener('click', (e) => {
Â Â const btn = e.target.closest('button[data-type]');
Â Â if (!btn) return;
Â Â const rateType = btn.dataset.type;
Â Â const isSelectAll = btn.id.includes('selectAll');
Â Â batchSelect(rateType, isSelectAll);
});

// åˆ—è¡¨å¤é€‰æ¡†äº‹ä»¶
document.addEventListener('change', (e) => {
Â Â if (e.target.classList.contains('adapter-batch-selector')) {
Â Â Â Â const i = +e.target.dataset.i;
Â Â Â Â const isChecked = e.target.checked;
Â Â Â Â if (!isChecked) {
Â Â Â Â Â Â currentAdapters[i].selected = false;
Â Â Â Â } else {
Â Â Â Â Â Â delete currentAdapters[i].selected;
Â Â Â Â }
Â Â Â Â renderAdapterFilterList();
Â Â }
});

/* ---------- ç½‘ç»œè¯·æ±‚ ---------- */
async function saveAllAdapters(onlyGlobal = false) {
Â Â const pass = byId('adminPass').value.trim();
Â Â if (!pass) throw new Error('è¯·è¾“å…¥ç®¡ç†å¯†ç ');
Â Â 
Â Â const networkAliases = JSON.parse(byId('network-aliases-json').value.trim() || '{}');
Â Â const payload = { pass, config: { networkAliases } };
Â Â 
Â Â if (!onlyGlobal) {
Â Â Â Â payload.adapters = currentAdapters.map(a => {
Â Â Â Â Â Â const c = { ...a };
Â Â Â Â Â Â if (c.auth && !c.auth.type && !c.auth.name) delete c.auth;
Â Â Â Â Â Â if (c.postProcess) {
Â Â Â Â Â Â Â Â Object.keys(c.postProcess).forEach(k => !c.postProcess[k] && delete c.postProcess[k]);
Â Â Â Â Â Â Â Â if (!Object.keys(c.postProcess).length) delete c.postProcess;
Â Â Â Â Â Â }
Â Â Â Â Â Â if (c.mappings && !Object.keys(c.mappings).length) delete c.mappings;
Â Â Â Â Â Â if (c.customJs === '') delete c.customJs;
Â Â Â Â Â Â if (c.isBatchAPI === true) delete c.isBatchAPI;
Â Â Â Â Â Â if (c.allowNoVars === false) delete c.allowNoVars;
Â Â Â Â Â Â return c;
Â Â Â Â });
Â Â }
Â Â 
Â Â const r = await fetch(`${WORKER_URL}/saveConfig`, {
Â Â Â Â method: 'POST',
Â Â Â Â headers: { 'Content-Type': 'application/json' },
Â Â Â Â body: JSON.stringify(payload)
Â Â });
Â Â 
Â Â if (!r.ok) throw new Error(await r.text() || `HTTP ${r.status}`);
Â Â byId('adminPass').value = '';
Â Â return { success: true, message: 'ä¿å­˜æˆåŠŸ' };
}

byId('saveToKV').onclick = async () => {
Â Â try {
Â Â Â Â const result = await saveAllAdapters(false);
Â Â Â Â alert(result.message);
Â Â Â Â byId('status').textContent = 'ğŸ’¾ é…ç½®ä¿å­˜æˆåŠŸ';
Â Â } catch (e) {
Â Â Â Â alert('ä¿å­˜å¤±è´¥ï¼š' + e.message);
Â Â Â Â byId('status').textContent = 'âŒ ä¿å­˜å¤±è´¥ï¼š' + e.message;
Â Â }
};

byId('loadFromKV').onclick = async () => {
Â Â const pass = byId('adminPass').value.trim();
Â Â if (!pass) return alert('è¯·è¾“å…¥ç®¡ç†å¯†ç ');
Â Â 
Â Â try {
Â Â Â Â const r = await fetch(`${WORKER_URL}/getConfig`, {
Â Â Â Â Â Â method: 'POST',
Â Â Â Â Â Â headers: { 'content-type': 'application/json' },
Â Â Â Â Â Â body: JSON.stringify({ pass })
Â Â Â Â });
Â Â Â Â 
Â Â Â Â if (!r.ok) throw new Error(await r.text() || `HTTP ${r.status}`);
Â Â Â Â const j = await r.json();
Â Â Â Â 
Â Â Â Â currentAdapters = Array.isArray(j.adapters) ? j.adapters : [];
Â Â Â Â byId('network-aliases-json').value = JSON.stringify(j.networkAliases || {}, null, 2);
Â Â Â Â visibleAdapterIndex = 'all';
Â Â Â Â renderAdapters();
Â Â Â Â alert('é…ç½®åŠ è½½æˆåŠŸ');
Â Â Â Â byId('status').textContent = `ğŸ“¥ åŠ è½½æˆåŠŸï¼š${currentAdapters.length} ä¸ªé€‚é…å™¨`;
Â Â } catch (e) {
Â Â Â Â alert('åŠ è½½å¤±è´¥ï¼š' + e.message);
Â Â Â Â byId('status').textContent = 'âŒ åŠ è½½å¤±è´¥ï¼š' + e.message;
Â Â } finally {
Â Â Â Â byId('adminPass').value = '';
Â Â }
};

/* ---------- æ¯”ä»·åŠŸèƒ½ ---------- */
byId('compare').onclick = async () => {
Â Â const from = byId('from').value.trim().toUpperCase() || null;
Â Â const to = byId('to').value.trim().toUpperCase() || null;
Â Â const fromNet = byId('fromNetwork').value.trim().toUpperCase() || null;
Â Â const toNet = byId('toNetwork').value.trim().toUpperCase() || null;
Â Â const amount = Number(byId('amount').value.trim());
Â Â 
Â Â if (!from || !to) return alert('è¯·è¾“å…¥å¸ç§ From å’Œ To');
Â Â if (!Number.isFinite(amount) || amount <= 0) return alert('æ•°é‡å¿…é¡»æ˜¯å¤§äº 0 çš„æ•°å­—');
Â Â 
Â Â queryPair = { from, to, fromNetwork: fromNet, toNetwork: toNet, amount };
Â Â const mode = qs('input[name="mode"]:checked').value;
Â Â const sendAdapters = currentAdapters.filter(a => a.selected !== false && a.rateType === mode);
Â Â 
Â Â if (!sendAdapters.length) {
Â Â Â Â byId('status').textContent = `æœªæ‰¾åˆ°åŒ¹é…æ¨¡å¼ "${mode}" çš„é€‚é…å™¨`;
Â Â Â Â return;
Â Â }
Â Â 
Â Â byId('status').textContent = 'ğŸ”„ æŸ¥è¯¢ä¸­ï¼Œè¯·ç¨å€™...';
Â Â byId('warnings').innerHTML = '';
Â Â qsa('table tbody').forEach(t => t.innerHTML = '');
Â Â qsa('.summary').forEach(s => s.style.display = 'none');
Â Â byId('copyJson').style.display = 'none';
Â Â 
Â Â const controller = new AbortController();
Â Â const timeout = setTimeout(() => controller.abort(), 30000); // 30ç§’è¶…æ—¶
Â Â 
Â Â try {
Â Â Â Â const r = await fetch(WORKER_URL, {
Â Â Â Â Â Â method: 'POST',
Â Â Â Â Â Â headers: { 'content-type': 'application/json' },
Â Â Â Â Â Â signal: controller.signal,
Â Â Â Â Â Â body: JSON.stringify({ pair: queryPair, adapters: sendAdapters })
Â Â Â Â });
Â Â Â Â 
Â Â Â Â if (!r.ok) throw new Error(await r.text() || `HTTP ${r.status}`);
Â Â Â Â const rj = await r.json();
Â Â Â Â lastResults = rj;
Â Â Â Â showResults(rj);
Â Â Â Â byId('status').textContent = `âœ… æŸ¥è¯¢å®Œæˆï¼Œå…± ${rj.results.length} æ¡ï¼Œè€—æ—¶ ${rj.timeTaken || '?'}ms`;
Â Â Â Â byId('copyJson').style.display = 'inline-block';
Â Â } catch (e) {
Â Â Â Â byId('status').textContent = e.name === 'AbortError' ? 'â° è¯·æ±‚è¶…æ—¶' : 'âŒ é”™è¯¯: ' + e.message;
Â Â } finally {
Â Â Â Â clearTimeout(timeout);
Â Â }
};

/* ---------- ç»“æœå±•ç¤º ---------- */
function showResults(res) {
Â Â const all = res.results || [];
Â Â const floating = all.filter(r => r.rateType === 'floating');
Â Â const locked = all.filter(r => r.rateType === 'locked');
Â Â 
Â Â const sort = (a, b) => (b.outputAmount ?? -Infinity) - (a.outputAmount ?? -Infinity);
Â Â floating.sort(sort);
Â Â locked.sort(sort);
Â Â 
Â Â qs('#floatingTable tbody').innerHTML = buildRateRows(floating, 0);
Â Â qs('#lockedTable tbody').innerHTML = buildRateRows(locked, 0);
Â Â 
Â Â renderSummary(floating.filter(r => r.ok), '#floatingSummary', floating[0]);
Â Â renderSummary(locked.filter(r => r.ok), '#lockedSummary', locked[0]);
Â Â 
Â Â // æ˜¾ç¤ºè­¦å‘Š
Â Â const wDiv = byId('warnings');
Â Â wDiv.innerHTML = '';
Â Â (res.warnings || []).forEach(w => {
Â Â Â Â const div = document.createElement('div');
Â Â Â Â div.className = 'warn-item';
Â Â Â Â div.innerHTML = `âš ï¸ <strong>[${w.adapter || 'å…¨å±€'}]</strong>: ${w.message || w.error || 'è­¦å‘Š'}`;
Â Â Â Â wDiv.appendChild(div);
Â Â });
}

function renderSummary(data, sel, best) {
Â Â const div = qs(sel);
Â Â if (!data.length || !best?.outputAmount) {
Â Â Â Â div.style.display = 'none';
Â Â Â Â return;
Â Â }
Â Â 
Â Â div.style.display = 'block';
Â Â div.innerHTML = `
Â Â Â Â <div style="font-size:16px;font-weight:600;margin-bottom:12px">
Â Â Â Â Â Â ğŸ“Š äº¤æ˜“æ±‡æ€»
Â Â Â Â </div>
Â Â Â Â <p style="margin:8px 0">
Â Â Â Â Â Â <strong>è¾“å…¥:</strong> 
Â Â Â Â Â Â <span style="color:#10b981;font-size:18px;font-weight:bold">
Â Â Â Â Â Â Â Â ${queryPair.amount} ${escapeHtml(queryPair.from || '')}
Â Â Â Â Â Â </span>
Â Â Â Â </p>
Â Â Â Â <p style="margin:8px 0">
Â Â Â Â Â Â <strong>æœ€ä¼˜ç»“æœ (${escapeHtml(best.name)}):</strong> 
Â Â Â Â Â Â <span style="color:#10b981;font-size:22px;font-weight:bold">
Â Â Â Â Â Â Â Â ${Number(best.outputAmount).toFixed(6)} ${escapeHtml(queryPair.to || '')}
Â Â Â Â Â Â </span>
Â Â Â Â </p>
Â Â Â Â <p style="margin:8px 0;color:#6b7280;font-size:14px">
Â Â Â Â Â Â å…± ${data.length} ä¸ªäº¤æ˜“æ‰€è¿”å›æœ‰æ•ˆç»“æœ
Â Â Â Â </p>
Â Â `;
}

/* ---------- å¯¼å…¥/å¯¼å‡º ---------- */
byId('importBtn').onclick = async () => {
Â Â const text = byId('importJson').value.trim();
Â Â const pass = byId('adminPass').value.trim();
Â Â 
Â Â if (!pass) return alert('è¯·å…ˆè¾“å…¥ç®¡ç†å¯†ç ');
Â Â if (!text) return alert('è¯·ç²˜è´´é€‚é…å™¨ JSON');
Â Â 
Â Â let adapter;
Â Â try {
Â Â Â Â adapter = JSON.parse(text);
Â Â Â Â if (!adapter || typeof adapter !== 'object' || Array.isArray(adapter) || !adapter.name) {
Â Â Â Â Â Â throw new Error('ç¼ºå°‘ name å­—æ®µæˆ–æ ¼å¼é”™è¯¯');
Â Â Â Â }
Â Â } catch (e) {
Â Â Â Â return alert('JSON æ ¼å¼é”™è¯¯: ' + e.message);
Â Â }
Â Â 
Â Â const exist = currentAdapters.find(a => a.name === adapter.name);
Â Â if (exist && !confirm(`è¦†ç›–åŒåé€‚é…å™¨ã€${adapter.name}ã€‘ï¼Ÿ`)) return;
Â Â 
Â Â if (exist) currentAdapters = currentAdapters.filter(a => a.name !== adapter.name);
Â Â currentAdapters.push(adapter);
Â Â 
Â Â try {
Â Â Â Â await saveAllAdapters(false);
Â Â Â Â byId('importJson').value = '';
Â Â Â Â alert(`âœ… ã€${adapter.name}ã€‘å¯¼å…¥æˆåŠŸ`);
Â Â Â Â renderAdapters();
Â Â Â Â byId('status').textContent = `ğŸ“¦ å¯¼å…¥æˆåŠŸï¼š${adapter.name}`;
Â Â } catch (err) {
Â Â Â Â alert('ä¿å­˜å¤±è´¥ï¼š' + err.message);
Â Â }
};

byId('copyJson').onclick = () => {
Â Â if (!lastResults) return alert('æ— æŸ¥è¯¢æ•°æ®');
Â Â const txt = JSON.stringify(lastResults, null, 2);
Â Â navigator.clipboard.writeText(txt)
Â Â Â Â .then(() => alert('âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'))
Â Â Â Â .catch(() => {
Â Â Â Â Â Â prompt('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶:', txt);
Â Â Â Â });
};

/* ---------- è‡ªåŠ¨åŠ è½½å…¬å¼€é€‚é…å™¨ ---------- */
async function autoLoadPublicAdapters() {
Â Â if (currentAdapters.length || !WORKER_URL || WORKER_URL.includes('your-worker')) return;
Â Â 
Â Â try {
Â Â Â Â const r = await fetch(`${WORKER_URL}/getAdapters`);
Â Â Â Â if (!r.ok) throw new Error();
Â Â Â Â const list = await r.json();
Â Â Â Â 
Â Â Â Â if (Array.isArray(list) && list.length) {
Â Â Â Â Â Â currentAdapters = list;
Â Â Â Â Â Â renderAdapters();
Â Â Â Â Â Â byId('status').textContent = `ğŸŒ å…¬å¼€é€‚é…å™¨åŠ è½½æˆåŠŸï¼ˆ${list.length} ä¸ªï¼‰`;
Â Â Â Â }
Â Â } catch {
Â Â Â Â byId('status').textContent = 'æš‚æ— å…¬å¼€é€‚é…å™¨ï¼Œç®¡ç†å‘˜è¯·åŠ è½½é…ç½®';
Â Â }
}

/* ---------- é‚®ç®±åçˆ¬ ---------- */
const setupEmail = () => {
Â Â const u = 'yanfei6868', d = 'icloud.com', m = u + '@' + d;
Â Â const mailEl = byId('mail');
Â Â mailEl.href = 'mailto:' + m;
Â Â mailEl.textContent = `ğŸ“§ ${m}`;
};
setupEmail();

/* ---------- æ¨¡å¼åˆ‡æ¢ ---------- */
function toggleProMode(on) {
Â Â document.body.classList.toggle('reactor-mode', on);
Â Â document.body.classList.toggle('simple-mode', !on);
Â Â const lbl = byId('modeLabel');
Â Â lbl.innerHTML = `
Â Â Â Â <input type="checkbox" id="proMode" style="display:none">
Â Â Â Â ${on ? 'ğŸ”¥ æ ¸ååº”å †æ¨¡å¼ï¼ˆå±•å¼€å…¨éƒ¨ï¼‹æ˜¾ç¤ºé«˜çº§å­—æ®µï¼‰' : 'ğŸ‘¤ äººç±»å‹å¥½æ¨¡å¼ï¼ˆæç®€é…ç½®ï¼‰'}
Â Â `;
Â Â lbl.style.background = on ? '#ef4444' : '#10b981';
Â Â 
Â Â if (visibleAdapterIndex === 'all') {
Â Â Â Â renderAdapters();
Â Â }
}

// æ¨¡å¼åˆ‡æ¢äº‹ä»¶
byId('modeLabel').onclick = (e) => {
Â Â e.preventDefault();
Â Â const checkbox = byId('proMode');
Â Â checkbox.checked = !checkbox.checked;
Â Â toggleProMode(checkbox.checked);
};

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
Â Â byId('proMode').checked = false;
Â Â toggleProMode(false);
Â Â renderAdapters();
Â Â autoLoadPublicAdapters();
Â Â 
Â Â // é»˜è®¤æ·»åŠ ä¸€ä¸ªç¤ºä¾‹é€‚é…å™¨
Â Â if (currentAdapters.length === 0) {
Â Â Â Â byId('addAdapter').click();
Â Â }
});
</script>
</body>
</html>
