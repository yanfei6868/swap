<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å³æ—¶å…‘æ¢æ±‡ç‡å¯¹æ¯”ï¼ˆå¤šé“¾ç‰ˆï¼‰ v20251117-SLIM-PRO</title>
<style>
/* ---- åŸå­ç±» ---- */
.b1{border:1px solid #ddd}.br4{border-radius:4px}.p4{padding:4px}.p8{padding:8px}.m6y{margin:6px 0}
.fs13{font-size:13px}.fs15{font-size:15px}.bgf5{background:#f5f5f5}.bgf9{background:#f9f9f9}
.w90{width:90%}.flex{display:flex}.gap10{gap:10px}.fwrap{flex-wrap:wrap}
/* ---- ç»„ä»¶ ---- */
body{font-family:-apple-system,"Helvetica Neue",Arial;margin:12px;font-size:14px}
input,button,select,textarea{font-size:15px;padding:4px;border-radius:4px;border:1px solid #ccc}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border-bottom:1px solid #ddd;padding:8px;text-align:left}
.ok{color:green}.err{color:#c00}.best-mark{color:green;font-weight:bold;margin-left:4px}
.output-cell{font-size:1.05em}.output-cell.best{font-size:1.15em}
.warn-item{color:orange;font-weight:bold;margin-top:5px}
.section-title{margin-top:20px;border-bottom:2px solid #555;padding-bottom:5px}
.config-area{border:1px solid #aaa;padding:8px;margin-top:16px;background:#f5f5f5;border-radius:4px}
.summary{margin-top:15px;padding:10px;border:1px solid #eee;border-radius:4px;background:#f0f8ff}
.adapter-item{border:1px solid #eee;padding:8px;margin:6px 0;border-radius:4px;background:#f9f9f9}
.adapter-filter-list{margin-top:5px;padding:5px;border:1px dashed #ccc;background:#fff;max-height:200px;overflow-y:auto}
.adapter-filter-item{display:inline-block;padding:4px 8px;margin:3px;border:1px solid #d0d0d0;border-radius:4px;cursor:pointer;font-size:13px;position:relative;padding-left:0px;transition:.2s} /* ç§»é™¤ padding-left:18px */
.adapter-filter-item:hover{background:#e9e9e9}
.adapter-filter-item.active{background:#ff5757;color:#fff;border-color:#ff5757;font-weight:bold;box-shadow:0 0 5px rgba(255,87,87,.5)}
.adapter-filter-item.locked.active{background:#32cd32;border-color:#32cd32;box-shadow:0 0 5px rgba(50,205,50,.5)}
/* .adapter-filter-item.selected::before{content:'âœ…';position:absolute;left:1px;top:50%;transform:translateY(-50%) scale(.75)} */ /* ç§»é™¤æ—§çš„é€‰ä¸­æ ‡è®° */
.collapsible{cursor:pointer;padding:8px;width:100%;border:none;text-align:left;font-size:15px;background:#ddd;margin-top:10px;border-radius:4px}
.content{padding:0 18px;max-height:0;overflow:hidden;transition:max-height .2s;background:#f1f1f1;border-radius:4px}
.content.active{padding-bottom:10px}
.import-box{border:2px dashed #28a745;padding:10px;margin-top:10px;border-radius:4px;background:#d4edda}
#importBtn{background:#28a745;color:#fff;font-weight:bold;font-size:16px;padding:10px 20px}
.contact-area{border:1px solid #007bff;padding:10px;margin-top:20px;background:#e6f7ff;border-radius:4px}
.contact-area ul{list-style:none;padding:0}
.contact-area li{margin-bottom:5px}

/* --- ç²¾ç®€æ¨¡å¼ (Simple Mode) --- */
.simple-mode .pro-field{display:none !important}
.simple-mode .collapsible,.simple-mode .content{display:none !important}

/* --- æ ¸ååº”å †æ¨¡å¼ (Reactor Mode) --- */
.reactor-mode .reactor-field{ display:block !important }
.reactor-mode .collapsible{ display:block !important }
.reactor-mode .content{ max-height:none !important; display:block !important }
.reactor-field{ display:none } /* é»˜è®¤éšè— */
</style>
</head>
<body>
<h2>å³æ—¶å…‘æ¢æ±‡ç‡å¯¹æ¯”ï¼ˆå¤šé“¾ç‰ˆï¼‰</h2>

<div>
Â Â <label>å¸ç§From:<input id="from" style="width:80px"></label>
Â Â <label>é“¾From:<input id="fromNetwork" style="width:80px"></label>
Â Â <label>å¸ç§To:<input id="to" style="width:80px"></label>
Â Â <label>é“¾To:<input id="toNetwork" style="width:80px"></label>
Â Â <label>æ•°é‡:<input id="amount" style="width:80px"></label>

Â Â <label style="margin-left:12px;"><input type="radio" name="mode" id="modeFloating" value="floating" checked> æŸ¥æµ®åŠ¨</label>
Â Â <label><input type="radio" name="mode" id="modeLocked" value="locked"> æŸ¥é”å®š</label>

Â Â <button id="compare" style="margin-left:8px;">ä¸€é”®æ¯”ä»·</button>
Â Â <button id="copyJson" style="margin-left:8px;display:none;">å¤åˆ¶ JSON</button>
</div>

<div id="history-area" class="config-area" style="margin-top:10px;padding:8px;background:#f0f8ff;">
Â Â <h4 style="margin:0 0 5px 0;border-bottom:1px solid #ccc;padding-bottom:5px;display:flex;justify-content:space-between;align-items:center;">
Â Â Â Â Â Â <span>å†å²æŸ¥è¯¢è®°å½• (ç‚¹å‡»å¡«å……)</span>
Â Â Â Â Â Â <button id="clearHistoryBtn" class="fs13" style="padding:2px 8px;font-weight:normal;">æ¸…ç©ºè®°å½•</button>
Â Â </h4>
Â Â <div id="historyList" class="flex fwrap gap10" style="font-size:13px;">
Â Â Â Â </div>
</div>
<div style="margin:20px 0;text-align:center">
Â Â <label id="modeLabel" style="background:#28a745;color:#fff;padding:10px 20px;border-radius:50px;cursor:pointer;font-size:16px">
Â Â Â Â <input type="checkbox" id="proMode" style="display:none">
Â Â Â Â äººç±»å‹å¥½æ¨¡å¼ï¼ˆæç®€é…ç½®ï¼‰
Â Â </label>
</div>

<div id="status" class="fs13" style="margin:10px 0">è¯·è®¾ç½® WORKER_URL</div>
<div id="warnings" style="margin:10px 0"></div>

<h4 style="color:#007bff">æµ®åŠ¨æ±‡ç‡</h4>
<table id="floatingTable"><thead><tr><th>äº¤æ˜“æ‰€</th><th>é¢„ä¼°è¾“å‡ºé‡</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
<div id="floatingSummary" class="summary" style="display:none"></div>

<h4 style="color:#28a745">é”å®šæ±‡ç‡</h4>
<table id="lockedTable"><thead><tr><th>äº¤æ˜“æ‰€</th><th>é¢„ä¼°è¾“å‡ºé‡</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
<div id="lockedSummary" class="summary" style="display:none"></div>

<div class="config-area">
Â Â <h3 class="section-title">äº¤æ˜“æ‰€é€‚é…å™¨ç®¡ç†ï¼ˆéœ€å¯†ç ï¼‰</h3>
Â Â <div>
Â Â Â Â <input id="adminPass" type="password" placeholder="è¾“å…¥ç®¡ç†å¯†ç " style="width:140px">
Â Â Â Â <button id="loadFromKV">ä»åç«¯åŠ è½½é…ç½®</button>
Â Â Â Â <button id="saveToKV">ä¿å­˜åˆ°åç«¯</button>
Â Â </div>

Â Â <div style="margin-top:10px">
Â Â Â Â <button id="showAllAdapters" class="fs13" style="margin-bottom:5px">æ˜¾ç¤ºå…¨éƒ¨é€‚é…å™¨</button>
Â Â Â Â <button id="selectAllFloating" class="fs13" data-type="floating">å…¨é€‰æµ®åŠ¨</button>
Â Â Â Â <button id="deselectAllFloating" class="fs13" data-type="floating">å…¨ä¸é€‰æµ®åŠ¨</button>

Â Â Â Â <div class="b1 p4 br4" style="border-color:#007bff">
Â Â Â Â Â Â <div style="font-weight:bold;color:#007bff;font-size:14px">æµ®åŠ¨æ±‡ç‡åˆ—è¡¨ (Floating)</div>
Â Â Â Â Â Â <div id="floatingAdapterList" class="adapter-filter-list"></div>
Â Â Â Â </div>
Â Â Â Â 
Â Â Â Â <button id="selectAllLocked" class="fs13" data-type="locked" style="margin-top:10px">å…¨é€‰é”å®š</button>
Â Â Â Â <button id="deselectAllLocked" class="fs13" data-type="locked">å…¨ä¸é€‰é”å®š</button>
Â Â Â Â <div class="b1 p4 br4" style="margin-top:10px;border-color:#28a745">
Â Â Â Â Â Â <div style="font-weight:bold;color:#28a745;font-size:14px">é”å®šæ±‡ç‡åˆ—è¡¨ (Locked)</div>
Â Â Â Â Â Â <div id="lockedAdapterList" class="adapter-filter-list"></div>
Â Â Â Â </div>
Â Â </div>

Â Â <div class="fs13">å¯æ·»åŠ æˆ–åˆ é™¤è‡ªå®šä¹‰äº¤æ˜“æ‰€ APIã€‚é…ç½®å°†ä¿å­˜åˆ° Cloudflare Worker KV ä¸­ã€‚</div>
Â Â <button id="addAdapter" style="margin:5px 0 10px 0">æ–°å¢äº¤æ˜“æ‰€</button>

Â Â <div class="import-box">
Â Â Â Â <button id="importBtn" class="import-btn">ä¸€é”®å¯¼å…¥/è¦†ç›–é€‚é…å™¨</button>
Â Â Â Â <textarea id="importJson" placeholder="ç²˜è´´å®Œæ•´é€‚é…å™¨ JSON è¿™é‡Œï¼Œä¸€é”®å¯¼å…¥å³å¯è¦†ç›–åŒåé€‚é…å™¨" rows="4" style="width:100%;box-sizing:border-box;margin-top:5px"></textarea>
Â Â </div>
Â Â <div id="adapterList"></div>
</div>

<div id="admin-panel" class="config-area">
Â Â <h3 class="section-title" style="margin-top:0">å…¨å±€ç½‘ç»œåˆ«åæ˜ å°„</h3>
Â Â <label>ç½‘ç»œåˆ«åæ˜ å°„ (NETWORK_ALIASES JSON):
Â Â Â Â <textarea id="network-aliases-json" style="width:100%;height:120px">{"BTC":"BITCOIN","ETH":"ETHEREUM","TRX":"TRON","BNB":"BSC","SOL":"SOLANA","MAINNET":"BITCOIN"}</textarea>
Â Â </label>
</div>

<div class="contact-area">
Â Â <h4 class="section-title" style="margin-top:0;border-bottom:none">è”ç³»ä½œè€…</h4>
Â Â <p>æœ‰å»ºè®® / åˆä½œ / é—®é¢˜ï¼Ÿ</p>
Â Â <p>
Â Â Â Â <a id="mail" href="#" style="color:#007bff"></a><br>
Â Â Â Â <a href="https://github.com/yourname/your-repo" target="_blank" rel="noopener">ğŸ™ GitHub ä»“åº“</a>
Â Â </p>
</div>

<script>
/* ---------- é…ç½® ---------- */
const WORKER_URL = 'https://your-worker.your-username.workers.dev';
let currentAdapters = [], queryPair = {}, lastResults = null, visibleAdapterIndex = 'all';

/* ---------- å·¥å…· ---------- */
const escapeHtml = s => s == null ? '' : String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
const byId = id => document.getElementById(id);
const qs = (sel, ctx = document) => ctx.querySelector(sel);
const qsa = (sel, ctx = document) => [...ctx.querySelectorAll(sel)];

/* --- æ–°å¢ï¼šå†å²è®°å½•åŠŸèƒ½ --- */
const HISTORY_KEY = 'rateComparisonHistory';
const MAX_HISTORY = 10; // æœ€å¤§å­˜å‚¨æ¡ç›®æ•°

// è·å–å†å²è®°å½•
function getHistory() {
Â Â Â Â try {
Â Â Â Â Â Â Â Â const historyJson = localStorage.getItem(HISTORY_KEY);
Â Â Â Â Â Â Â Â return historyJson ? JSON.parse(historyJson) : [];
Â Â Â Â } catch (e) {
Â Â Â Â Â Â Â Â console.error("Error reading history from localStorage:", e);
Â Â Â Â Â Â Â Â return [];
Â Â Â Â }
}

// è¾…åŠ©å‡½æ•°ï¼šæ ‡å‡†åŒ–å†å²è®°å½•æ¡ç›®çš„ JSON å­—ç¬¦ä¸² (ğŸ”¥ ä½¿ç”¨ Object.keys(pair).sort() ä¿®å¤é”®åºé£é™©)
function getStandardizedEntry(pair) {
Â Â Â Â // ç¡®ä¿æ‰€æœ‰é”®å§‹ç»ˆæŒ‰å­—æ¯é¡ºåºæ’åºï¼Œé˜²æ­¢å› ä¸ºé”®åºå˜åŒ–å¯¼è‡´é‡å¤è®°å½•
Â Â Â Â return JSON.stringify(pair, Object.keys(pair).sort());
}

// æ·»åŠ æ–°çš„å†å²è®°å½•
function addHistory(pair) {
Â Â Â Â const history = getHistory();
Â Â Â Â 
Â Â Â Â // 1. æ ‡å‡†åŒ–å½“å‰æ¡ç›®ç”¨äºæ¯”è¾ƒ
Â Â Â Â const newEntryStandardized = getStandardizedEntry(pair);
Â Â Â Â 
Â Â Â Â // 2. æŸ¥æ‰¾æ˜¯å¦æœ‰å·²å­˜åœ¨çš„æ ‡å‡†åŒ–æ¡ç›®
Â Â Â Â const existingIndex = history.findIndex(item => getStandardizedEntry(item) === newEntryStandardized);

Â Â Â Â if (existingIndex !== -1) {
Â Â Â Â Â Â Â Â // å¦‚æœå­˜åœ¨ï¼Œå…ˆç§»é™¤æ—§çš„ (ä¿æŒæœ€æ–°è®°å½•åœ¨é¡¶éƒ¨)
Â Â Â Â Â Â Â Â history.splice(existingIndex, 1);
Â Â Â Â }
Â Â Â Â 
Â Â Â Â // 3. å°†æ–°è®°å½•æ·»åŠ åˆ°æœ€å‰é¢
Â Â Â Â history.unshift(pair);

Â Â Â Â // 4. é™åˆ¶æ•°é‡
Â Â Â Â if (history.length > MAX_HISTORY) {
Â Â Â Â Â Â Â Â history.length = MAX_HISTORY;
Â Â Â Â }

Â Â Â Â try {
Â Â Â Â Â Â Â Â localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
Â Â Â Â } catch (e) {
Â Â Â Â Â Â Â Â console.error("Error writing history to localStorage:", e);
Â Â Â Â }
}

// æ¸²æŸ“å†å²è®°å½•åˆ—è¡¨
function renderHistory() {
Â Â Â Â const listDiv = byId('historyList');
Â Â Â Â listDiv.innerHTML = '';
Â Â Â Â const history = getHistory();

Â Â Â Â if (history.length === 0) {
Â Â Â Â Â Â Â Â listDiv.textContent = 'æš‚æ— å†å²è®°å½•';
Â Â Â Â Â Â Â Â // byId('clearHistoryBtn').style.display = 'none'; // å¯ä»¥é€‰æ‹©åœ¨æ— è®°å½•æ—¶éšè—æ¸…ç©ºæŒ‰é’®
Â Â Â Â Â Â Â Â return;
Â Â Â Â }
Â Â Â Â 
Â Â Â Â // byId('clearHistoryBtn').style.display = 'inline-block';

Â Â Â Â history.forEach((pair) => {
Â Â Â Â Â Â Â Â const item = document.createElement('div');
Â Â Â Â Â Â Â Â item.className = 'br4 p4 bgf9';
Â Â Â Â Â Â Â Â item.style.cursor = 'pointer';
Â Â Â Â Â Â Â Â item.style.border = '1px solid #ddd';

Â Â Â Â Â Â Â Â // é¿å… null/undefined æ˜¾ç¤º
Â Â Â Â Â Â Â Â const fromText = `${pair.from || ''}${pair.fromNetwork ? `(${pair.fromNetwork})` : ''}`;
Â Â Â Â Â Â Â Â const toText = `${pair.to || ''}${pair.toNetwork ? `(${pair.toNetwork})` : ''}`;
Â Â Â Â Â Â Â Â const modeEmoji = pair.mode === 'locked' ? 'ğŸ”’' : 'ğŸ’¨';

Â Â Â Â Â Â Â Â item.innerHTML = `
Â Â Â Â Â Â Â Â Â Â Â Â ${modeEmoji} ${Number(pair.amount).toFixed(2)} ${fromText} â¡ï¸ ${toText}
Â Â Â Â Â Â Â Â `;
Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼šå¡«å……è¾“å…¥æ¡†
Â Â Â Â Â Â Â Â item.onclick = () => applyHistory(pair);

Â Â Â Â Â Â Â Â listDiv.appendChild(item);
Â Â Â Â });
}

// å°†å†å²è®°å½•åº”ç”¨åˆ°è¾“å…¥æ¡†
function applyHistory(pair) {
Â Â Â Â byId('from').value = pair.from || '';
Â Â Â Â byId('fromNetwork').value = pair.fromNetwork || '';
Â Â Â Â byId('to').value = pair.to || '';
Â Â Â Â byId('toNetwork').value = pair.toNetwork || '';
Â Â Â Â byId('amount').value = pair.amount || '';
Â Â Â Â 
Â Â Â Â // é€‰ä¸­æŸ¥è¯¢æ¨¡å¼ï¼ˆæµ®åŠ¨/é”å®šï¼‰
Â Â Â Â const modeElement = byId(pair.mode === 'locked' ? 'modeLocked' : 'modeFloating');
Â Â Â Â if (modeElement) {
Â Â Â Â Â Â Â Â modeElement.checked = true;
Â Â Â Â }

Â Â Â Â byId('status').textContent = 'âœ… å·²ä»å†å²è®°å½•å¡«å……ï¼Œè¯·ç‚¹å‡»â€œä¸€é”®æ¯”ä»·â€';
}
/* --- å†å²è®°å½•åŠŸèƒ½ç»“æŸ --- */


/* ---------- æ¸²æŸ“æ±‡ç‡è¡¨ ---------- */
function buildRateRows(data, bestIdx = 0){
Â Â return data.map((r,i) => {
Â Â Â Â const best = i === bestIdx && r.ok && r.outputAmount != null;
Â Â Â Â const out = r.ok && r.outputAmount != null ? `${Number(r.outputAmount).toFixed(6)} ${queryPair.to}` : `<span class="err">${escapeHtml(r.error||'å¤±è´¥')}</span>`;
Â Â Â Â const link = r.ok && r.link && /^https?:\/\//i.test(r.link) ? `<a href="${escapeHtml(r.link)}" target="_blank" rel="noopener">å‰å¾€</a>` : '-';
Â Â Â Â return `<tr><td>${escapeHtml(r.name||'-')}${best?'<span class="best-mark">Best</span>':''}</td><td class="output-cell ${best?'best':''}" style="font-weight:${best?'bold':'normal'};color:${best?'green':'inherit'}">${out}</td><td>${link}</td></tr>`;
Â Â }).join('');
}

/* --- ä¼˜åŒ–åçš„é€‚é…å™¨æ ‡ç­¾åˆ—è¡¨åˆ›å»ºå‡½æ•° --- */
function createAdapterFilterItem(a, i, isSelected) {
Â Â Â Â const item = document.createElement('label');
Â Â Â Â item.className = `adapter-filter-item ${a.rateType === 'locked' ? 'locked' : ''} ${isSelected ? 'selected' : ''} ${i===visibleAdapterIndex?'active':''}`;
Â Â Â Â item.dataset.index = i;
Â Â Â Â 
Â Â Â Â item.innerHTML = `
Â Â Â Â Â Â Â Â <input type="checkbox" class="adapter-batch-selector" data-i="${i}" 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â style="margin-right:4px;" ${isSelected ? 'checked' : ''}>
Â Â Â Â Â Â Â Â <span class="pro-field" style="opacity:${i===visibleAdapterIndex?1:0};margin-right:4px;transition:opacity .2s">[#${+i+1}]</span>
Â Â Â Â Â Â Â Â ${escapeHtml(a.name || 'æœªå‘½å')}
Â Â Â Â `;
Â Â Â Â 
Â Â Â Â item.onmouseover = () => item.querySelector('.pro-field').style.opacity = '1';
Â Â Â Â item.onmouseout = () => {
Â Â Â Â Â Â Â Â if(+item.dataset.index !== visibleAdapterIndex) item.querySelector('.pro-field').style.opacity = '0';
Â Â Â Â };
Â Â Â Â 
Â Â Â Â item.onclick = e => {
Â Â Â Â Â Â Â Â if (e.target.classList.contains('adapter-batch-selector')) return;
Â Â Â Â Â Â Â Â showAdapter(i);
Â Â Â Â };
Â Â Â Â 
Â Â Â Â return item;
}

/* --- ä¼˜åŒ–åçš„é€‚é…å™¨æ ‡ç­¾åˆ—è¡¨æ¸²æŸ“å‡½æ•° --- */
function renderAdapterFilterList(){
Â Â const floatingList = byId('floatingAdapterList'), lockedList = byId('lockedAdapterList');
Â Â floatingList.innerHTML = lockedList.innerHTML = '';
Â Â 
Â Â const floatingAdapters = [], lockedAdapters = [];
Â Â currentAdapters.forEach((a, i) => {
Â Â Â Â Â Â const isSelected = a.selected !== false;
Â Â Â Â Â Â const list = a.rateType === 'floating' ? floatingAdapters : lockedAdapters;
Â Â Â Â Â Â list.push({ a, i, isSelected });
Â Â });
Â Â 
Â Â // æ¸²æŸ“æµ®åŠ¨åˆ—è¡¨
Â Â floatingAdapters.forEach(({ a, i, isSelected }) => {
Â Â Â Â Â Â const item = createAdapterFilterItem(a, i, isSelected);
Â Â Â Â Â Â floatingList.appendChild(item);
Â Â });
Â Â 
Â Â // æ¸²æŸ“é”å®šåˆ—è¡¨
Â Â lockedAdapters.forEach(({ a, i, isSelected }) => {
Â Â Â Â Â Â const item = createAdapterFilterItem(a, i, isSelected);
Â Â Â Â Â Â lockedList.appendChild(item);
Â Â });
}

/* ---------- æ¸²æŸ“å•ä¸ªé€‚é…å™¨ ---------- */
function renderAdapters(){
Â Â const container = byId('adapterList'), activeEl = document.activeElement;
Â Â container.innerHTML = '';
Â Â currentAdapters.forEach((a,i)=>{
Â Â Â Â const div = document.createElement('div');
Â Â Â Â div.className = 'adapter-item'; div.dataset.index = i;
Â Â Â Â if(visibleAdapterIndex!==i && visibleAdapterIndex!=='all') div.style.display='none';

Â Â Â Â /* ç”Ÿæˆé»˜è®¤å€¼ */
Â Â Â Â const authType = a.auth?.type||'header', authName = a.auth?.name||'';
Â Â Â Â const timeoutMs = a.timeoutMs||15000, successStatus = Array.isArray(a.successStatus)?a.successStatus.join(','):'200,201,204';
Â Â Â Â const defaultPaths = Array.isArray(a.defaultAmountPaths)?a.defaultAmountPaths.join(','):'estimatedAmount,toAmount';
Â Â Â Â const contentTypeMap = Array.isArray(a.contentTypeMap)?a.contentTypeMap.join(','):'application/json,text/html';
Â Â Â Â const bodyCt = a.bodyContentType||'json';
Â Â Â Â const ppHeader = a.postProcess?.headers?JSON.stringify(a.postProcess.headers,null,2):'';
Â Â Â Â const ppQueryÂ Â = a.postProcess?.query?JSON.stringify(a.postProcess.query,null,2):'';
Â Â Â Â const ppBodyÂ Â Â = a.postProcess?.body?JSON.stringify(a.postProcess.body,null,2):'';
Â Â Â Â const customJs = a.customJs||''; 

Â Â Â Â div.innerHTML = `
Â Â Â Â Â Â <label style="float:right;margin-right:10px"><input type="checkbox" class="adapter-selector" data-i="${i}" ${a.selected!==false?'checked':''}><b>æ¯”ä»·é€‰ä¸­</b></label>
Â Â Â Â Â Â <b>[#${i+1}] ${escapeHtml(a.name||'é€‚é…å™¨'+(i+1))}</b>
Â Â Â Â Â Â <div class="small">æ˜¾ç¤ºåç§°ï¼š<input data-i="${i}" class="name" value="${escapeHtml(a.name||'')}"></div>
Â Â Â Â Â Â <div class="small">URLæ¨¡æ¿ï¼š<input data-i="${i}" class="urlTemplate" value="${escapeHtml(a.urlTemplate||'')}"></div>
Â Â Â Â Â Â <div class="small">é“¾æ¥æ¨¡æ¿ï¼š<input data-i="${i}" class="linkTemplate" value="${escapeHtml(a.linkTemplate||'')}"></div>

Â Â Â Â Â Â <div class="small flex fwrap gap10" style="border:1px dashed #ccc;padding:5px;margin-top:5px;border-radius:4px">
Â Â Â Â Â Â Â Â <label>è¯·æ±‚æ–¹æ³•ï¼š<select data-i="${i}" class="method"><option value="GET" ${(a.method||'GET').toUpperCase()==='GET'?'selected':''}>GET</option><option value="POST" ${(a.method||'GET').toUpperCase()==='POST'?'selected':''}>POST</option></select></label>
Â Â Â Â Â Â Â Â <label>ç±»å‹ï¼š<select data-i="${i}" class="rateType"><option value="floating" ${a.rateType==='floating'?'selected':''}>æµ®åŠ¨</option><option value="locked" ${a.rateType==='locked'?'selected':''}>é”å®š</option></select></label>
Â Â Â Â Â Â Â Â <label>è§£æç±»å‹ï¼š<select data-i="${i}" class="parseType"><option value="json" ${a.parseType==='json'?'selected':''}>json</option><option value="html_regex" ${a.parseType==='html_regex'?'selected':''}>html_regex</option></select></label>
Â Â Â Â Â Â Â Â <label class="pro-field">æ‰¹é‡APIï¼š<select data-i="${i}" class="isBatchAPI"><option value="true" ${a.isBatchAPI!==false?'selected':''}>æ˜¯</option><option value="false" ${a.isBatchAPI===false?'selected':''}>å¦</option></select></label>
Â Â Â Â Â Â Â Â <label class="pro-field">è¶…æ—¶(ms)ï¼š<input type="number" data-i="${i}" class="timeoutMs" value="${timeoutMs}" style="width:80px"></label>
Â Â Â Â Â Â Â Â <label class="pro-field">æˆåŠŸçŠ¶æ€ï¼š<input data-i="${i}" class="successStatus" value="${escapeHtml(successStatus)}" placeholder="é€—å·åˆ†éš”" style="width:120px"></label>
Â Â Â Â Â Â Â Â <label class="pro-field">å¤‡é€‰è·¯å¾„ï¼š<input data-i="${i}" class="defaultAmountPaths" value="${escapeHtml(defaultPaths)}" placeholder="é€—å·åˆ†éš”" style="width:140px"></label>
Â Â Â Â Â Â Â Â <label class="pro-field">Content-Typeç™½åå•ï¼š<input data-i="${i}" class="contentTypeMap" value="${escapeHtml(contentTypeMap)}" placeholder="é€—å·åˆ†éš”" style="width:140px"></label>
Â Â Â Â Â Â </div>

Â Â Â Â Â Â <label style="margin-top:5px;display:block">è§£æç»“æœï¼š
Â Â Â Â Â Â Â Â <select data-i="${i}" class="parseResultAs"><option value="total" ${a.parseResultAs!=='rate'?'selected':''}>æ€»ä»·</option><option value="rate" ${a.parseResultAs==='rate'?'selected':''}>å•ä»·</option></select>
Â Â Â Â Â Â </label>
Â Â Â Â Â Â <label>è·¯å¾„/Regexï¼š<input data-i="${i}" class="parsePath" value="${escapeHtml(a.parsePath||'')}"></label>
Â Â Â Â Â Â ${a.parseType==='html_regex'?'<span class="err fs13">âš ï¸ éœ€è¦æ­£åˆ™ä¸”ä¸èƒ½ä¸ºç©º</span>':''}

Â Â Â Â Â Â <div class="small pro-field">Headers (JSON)ï¼š<textarea data-i="${i}" class="headers w90" rows="4">${escapeHtml(a.headers?JSON.stringify(a.headers,null,2):'')}</textarea></div>
Â Â Â Â Â Â <div class="small pro-field">Body Content Typeï¼š
Â Â Â Â Â Â Â Â <select data-i="${i}" class="bodyContentType"><option value="json" ${bodyCt==='json'?'selected':''}>json</option><option value="form" ${bodyCt==='form'?'selected':''}>form</option><option value="raw" ${bodyCt==='raw'?'selected':''}>raw</option></select>
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <div class="small pro-field">Bodyï¼š<textarea data-i="${i}" class="body w90" rows="4">${escapeHtml(typeof a.body==='object'?JSON.stringify(a.body,null,2):(a.body||''))}</textarea></div>
Â Â Â Â Â Â <div class="small pro-field">å¸ç§/é“¾åæ˜ å°„ï¼š<textarea data-i="${i}" class="mappings w90" rows="4">${escapeHtml(a.mappings?JSON.stringify(a.mappings,null,2):'')}</textarea></div>
Â Â Â Â Â Â 
Â Â Â Â Â Â <div class="small reactor-field">è¯·æ±‚å‰è„šæœ¬ (customJs)ï¼š<textarea data-i="${i}" class="customJs w90" rows="4" placeholder="function beforeRequest(config){ return config; }">${escapeHtml(customJs)}</textarea></div>

Â Â Â Â Â Â <div class="small" style="border:1px solid #ccc;padding:5px;border-radius:4px;margin-top:10px">
Â Â Â Â Â Â Â Â <label style="display:block">API Keyï¼š<input data-i="${i}" class="apiKey" value="${escapeHtml(a.apiKey||'')}"></label>
Â Â Â Â Â Â Â Â <div class="flex gap10">
Â Â Â Â Â Â Â Â Â Â <label>é‰´æƒä½ç½®ï¼š<select data-i="${i}" class="authType"><option value="header" ${authType==='header'?'selected':''}>Header</option><option value="query" ${authType==='query'?'selected':''}>Query</option><option value="" ${authType===''?'selected':''}>æ— </option></select></label>
Â Â Â Â Â Â Â Â Â Â <label>é‰´æƒåç§°ï¼š<input data-i="${i}" class="authName" value="${escapeHtml(authName)}"></label>
Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â </div>

Â Â Â Â Â Â <button type="button" class="collapsible pro-field" data-target="adv-${i}">âš™ï¸ é«˜çº§è®¾ç½®</button>
Â Â Â Â Â Â <div class="content pro-field" id="adv-${i}">
Â Â Â Â Â Â Â Â <div class="small pro-field"><b>åç½®å¤„ç† (JSON)ï¼š</b></div>
Â Â Â Â Â Â Â Â <label class="pro-field">åç½® Headerï¼š<textarea data-i="${i}" class="ppHeader w90" rows="3" placeholder="Header JSON">${escapeHtml(ppHeader)}</textarea></label>
Â Â Â Â Â Â Â Â <label class="pro-field">åç½® Queryï¼š<textarea data-i="${i}" class="ppQuery w90" rows="3" placeholder="Query JSON">${escapeHtml(ppQuery)}</textarea></label>
Â Â Â Â Â Â Â Â <label class="pro-field">åç½® Bodyï¼š<textarea data-i="${i}" class="ppBody w90" rows="3" placeholder="Body JSON">${escapeHtml(ppBody)}</textarea></label>
Â Â Â Â Â Â </div>

Â Â Â Â Â Â <button data-i="${i}" class="del">åˆ é™¤</button>
Â Â Â Â `;
Â Â Â Â container.appendChild(div);
Â Â });

Â Â /* äº‹ä»¶å§”æ‰˜ => 1 æ¬¡ç»‘å®š */
Â Â container.onchange = e =>{
Â Â Â Â const i = +e.target.dataset.i, p = e.target.classList[0];
Â Â Â Â if(!p||!Number.isFinite(i)) return;
Â Â Â Â let v = e.target.value.trim();
Â Â Â Â 
Â Â Â Â // ä¿®å¤ï¼šå¤„ç†è¯¦ç»†é…ç½®ä¸­çš„æ¯”ä»·é€‰ä¸­çŠ¶æ€åŒæ­¥ï¼Œå¹¶è§¦å‘é‡ç»˜
Â Â Â Â if(e.target.classList.contains('adapter-selector')){
Â Â Â Â Â Â if(!e.target.checked){
Â Â Â Â Â Â Â Â currentAdapters[i].selected = false;
Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â delete currentAdapters[i].selected;
Â Â Â Â Â Â }
Â Â Â Â Â Â renderAdapters(); // å…¨é‡é‡ç»˜å³ä¾§å’Œåˆ—è¡¨ï¼Œç¡®ä¿æ‰€æœ‰UIåŒæ­¥
Â Â Â Â Â Â return; 
Â Â Â Â }
Â Â Â Â 
Â Â Â Â if(p==='customJs' && v===''){
Â Â Â Â Â Â Â Â delete currentAdapters[i][p];
Â Â Â Â }
Â Â Â Â else if(['mappings','headers','body','ppHeader','ppQuery','ppBody'].includes(p)){
Â Â Â Â Â Â try{v = v?JSON.parse(v):null}catch{alert(`${p} JSON æ ¼å¼é”™è¯¯`);return}
Â Â Â Â }
Â Â Â Â if(p==='timeoutMs') v=Number(v)||15000;
Â Â Â Â if(p==='successStatus'||p==='defaultAmountPaths'||p==='contentTypeMap') v=v.split(',').map(s=>s.trim()).filter(Boolean);
Â Â Â Â if(p==='isBatchAPI') v=e.target.value!=='true'?false:void 0;
Â Â Â Â 
Â Â Â Â if(p.startsWith('pp')){Â Â Â // åç½®å¤„ç†
Â Â Â Â Â Â currentAdapters[i].postProcess=currentAdapters[i].postProcess||{};
Â Â Â Â Â Â currentAdapters[i].postProcess[p.slice(2).toLowerCase()]=v;
Â Â Â Â Â Â if(v===null) delete currentAdapters[i].postProcess[p.slice(2).toLowerCase()];
Â Â Â Â Â Â if(Object.keys(currentAdapters[i].postProcess).length===0) delete currentAdapters[i].postProcess;
Â Â Â Â }else{
Â Â Â Â Â Â if(v===''&&p!=='name') delete currentAdapters[i][p]; else currentAdapters[i][p]=v;
Â Â Â Â }
Â Â Â Â if(p==='name') renderAdapterFilterList();
Â Â Â Â if(p==='rateType'||p==='parseType') renderAdapters();Â Â Â // åˆ‡æ¢ç±»å‹ç«‹å³é‡ç»˜
Â Â };
Â Â container.onclick = e =>{
Â Â Â Â if(e.target.classList.contains('del')){ currentAdapters.splice(+e.target.dataset.i,1); visibleAdapterIndex='all'; renderAdapters(); }
Â Â Â Â if(e.target.classList.contains('collapsible')){
Â Â Â Â Â Â e.target.classList.toggle('active');
Â Â Â Â Â Â const cnt = byId(e.target.dataset.target);
Â Â Â Â Â Â cnt.classList.toggle('active');
Â Â Â Â Â Â // æ£€æŸ¥å½“å‰æ¨¡å¼ï¼Œå¦‚æœæ˜¯ Reactor Modeï¼Œåˆ™ä¸éœ€è¦ max-height åŠ¨ç”»
Â Â Â Â Â Â if(document.body.classList.contains('reactor-mode')){
Â Â Â Â Â Â Â Â Â cnt.style.maxHeight = 'none';
Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â Â cnt.style.maxHeight = cnt.classList.contains('active')?cnt.scrollHeight+'px':null;
Â Â Â Â Â Â }
Â Â Â Â }
Â Â };

Â Â renderAdapterFilterList();
Â Â if(visibleAdapterIndex!==null&&visibleAdapterIndex!=='all'){
Â Â Â Â const target=container.querySelector(`[data-index="${visibleAdapterIndex}"]`);
Â Â Â Â if(target) target.scrollIntoView({block:'start',behavior:'smooth'});
Â Â }
}

/* ---------- äº¤äº’ ---------- */
function showAdapter(idx){
Â Â visibleAdapterIndex=idx;
Â Â qsa('#adapterList .adapter-item').forEach(d=>d.style.display=+d.dataset.index===idx?'block':'none');
Â Â renderAdapterFilterList();
Â Â const tgt=qs(`[data-index="${idx}"]`,byId('adapterList'));
Â Â if(tgt) tgt.scrollIntoView({block:'start',behavior:'smooth'});
}
byId('showAllAdapters').onclick=()=>{visibleAdapterIndex='all';renderAdapters();};

byId('addAdapter').onclick=()=>{
Â Â currentAdapters.unshift({name:'æ–°äº¤æ˜“æ‰€',urlTemplate:'',method:'GET',parseType:'json',parsePath:'',parseResultAs:'total',rateType:'floating',timeoutMs:15000,bodyContentType:'json',successStatus:[200,201,204],defaultAmountPaths:['estimatedAmount','toAmount'],contentTypeMap:['application/json','text/html']});
Â Â visibleAdapterIndex=0; renderAdapters();
};

/* --- ä¼˜åŒ–åçš„æ‰¹é‡é€‰æ‹©é€»è¾‘ (ä¿®å¤é—®é¢˜ 2) --- */
function batchSelect(rateType, selectState) {
Â Â Â Â currentAdapters.forEach((a) => {
Â Â Â Â Â Â Â Â if (a.rateType === rateType) {
Â Â Â Â Â Â Â Â Â Â Â Â if (selectState) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â delete a.selected; // é€‰ä¸­æ—¶åˆ é™¤å­—æ®µ (é»˜è®¤é€‰ä¸­)
Â Â Â Â Â Â Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â a.selected = false; // å–æ¶ˆé€‰ä¸­æ—¶è®¾ä¸º false
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â }
Â Â Â Â });
Â Â Â Â 
Â Â Â Â // ä¿®å¤ï¼šç›´æ¥è°ƒç”¨ renderAdapters()ï¼Œå®ƒä¼šè§¦å‘ renderAdapterFilterList()ï¼Œå¹¶é‡ç»˜å³ä¾§è¯¦æƒ…ï¼Œ
Â Â Â Â // å½»åº•ä¿è¯æ‰€æœ‰UIå…ƒç´ ä¸å†…å­˜ä¸€è‡´ã€‚
Â Â Â Â renderAdapters(); 
Â Â Â Â 
Â Â Â Â // çŠ¶æ€åé¦ˆ
Â Â Â Â const count = currentAdapters.filter(a => a.rateType === rateType && a.selected !== false).length;
Â Â Â Â const total = currentAdapters.filter(a => a.rateType === rateType).length;
Â Â Â Â byId('status').textContent = `âœ… ${selectState ? 'å…¨é€‰' : 'å…¨ä¸é€‰'} ${rateType === 'floating' ? 'æµ®åŠ¨' : 'é”å®š'}æ±‡ç‡ (${count}/${total})`;
Â Â Â Â 
Â Â Â Â // ç§»é™¤æ‰‹åŠ¨åŒæ­¥é€»è¾‘
}

/* --- äº‹ä»¶å§”æ‰˜ï¼ˆå¤„ç†æ‰¹é‡é€‰æ‹©æŒ‰é’®ï¼‰ --- */
document.addEventListener('click', (e) => {
Â Â Â Â const btn = e.target.closest('button[data-type]');
Â Â Â Â if (!btn) return;
Â Â Â Â 
Â Â Â Â const rateType = btn.dataset.type;
Â Â Â Â const isSelectAll = btn.id.includes('selectAll');
Â Â Â Â 
Â Â Â Â batchSelect(rateType, isSelectAll);
});

/* --- äº‹ä»¶å§”æ‰˜ï¼ˆå¤„ç†åˆ—è¡¨å¤é€‰æ¡†ï¼‰(ä¼˜åŒ–åŒæ­¥é€»è¾‘) --- */
document.addEventListener('change', (e) => {
Â Â Â Â if (e.target.classList.contains('adapter-batch-selector')) {
Â Â Â Â Â Â Â Â const i = +e.target.dataset.i;
Â Â Â Â Â Â Â Â const isChecked = e.target.checked;
Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â if (!isChecked) {
Â Â Â Â Â Â Â Â Â Â Â Â currentAdapters[i].selected = false;
Â Â Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â Â Â Â Â delete currentAdapters[i].selected;
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â // ä¼˜åŒ–ï¼šä¸å†æ‰‹åŠ¨åŒæ­¥å³ä¾§å¤é€‰æ¡†å’Œåˆ—è¡¨æ ·å¼ï¼Œç›´æ¥å…¨é‡é‡ç»˜å³ä¾§å’Œåˆ—è¡¨ã€‚
Â Â Â Â Â Â Â Â renderAdapters();
Â Â Â Â }
});


/* ---------- ç½‘ç»œè¯·æ±‚ ---------- */
async function saveAllAdapters(onlyGlobal=false){
Â Â const pass=byId('adminPass').value.trim();
Â Â if(!pass) throw new Error('è¯·è¾“å…¥ç®¡ç†å¯†ç ');
Â Â const networkAliases=JSON.parse(byId('network-aliases-json').value.trim()||'{}');
Â Â const payload={pass,config:{networkAliases}};
Â Â if(!onlyGlobal){
Â Â Â Â payload.adapters=currentAdapters.map(a=>{
Â Â Â Â Â Â const c={...a};
Â Â Â Â Â Â if(c.auth&&!c.auth.type&&!c.auth.name) delete c.auth;
Â Â Â Â Â Â if(c.postProcess){ Object.keys(c.postProcess).forEach(k=>!c.postProcess[k]&&delete c.postProcess[k]); if(!Object.keys(c.postProcess).length) delete c.postProcess;}
Â Â Â Â Â Â if(c.mappings&&!Object.keys(c.mappings).length) delete c.mappings;
Â Â Â Â Â Â if(c.customJs==='') delete c.customJs; // æ£€æŸ¥ customJs 
Â Â Â Â Â Â return c;
Â Â Â Â });
Â Â }
Â Â const r=await fetch(WORKER_URL+'/saveConfig',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
Â Â if(!r.ok) throw new Error(await r.text()||'HTTP '+r.status);
Â Â byId('adminPass').value='';
Â Â return {success:true,message:'ä¿å­˜æˆåŠŸ'};
}
byId('saveToKV').onclick=async()=>{try{const m=await saveAllAdapters(false);alert(m.message);}catch(e){alert(e.message);}};
byId('loadFromKV').onclick=async()=>{
Â Â const pass=byId('adminPass').value.trim(); if(!pass) return alert('è¯·è¾“å…¥ç®¡ç†å¯†ç ');
Â Â try{
Â Â Â Â const r=await fetch(WORKER_URL+'/getConfig',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({pass})});
Â Â Â Â if(!r.ok) throw new Error(await r.text()||'HTTP '+r.status);
Â Â Â Â const j=await r.json();
Â Â Â Â currentAdapters=Array.isArray(j.adapters)?j.adapters:[];
Â Â Â Â byId('network-aliases-json').value=JSON.stringify(j.networkAliases||{},null,2);
Â Â Â Â visibleAdapterIndex='all'; renderAdapters(); alert('é…ç½®åŠ è½½æˆåŠŸ');
Â Â }catch(e){alert('åŠ è½½å¤±è´¥ï¼š'+e.message);}
Â Â finally{byId('adminPass').value='';}
};

/* ---------- æ¯”ä»· ---------- */
byId('compare').onclick=async()=>{
Â Â const from=byId('from').value.trim().toUpperCase()||null, to=byId('to').value.trim().toUpperCase()||null;
Â Â const fromNet=byId('fromNetwork').value.trim().toUpperCase()||null, toNet=byId('toNetwork').value.trim().toUpperCase()||null;
Â Â const amount=Number(byId('amount').value.trim());
Â Â if(!from||!to) return alert('è¯·è¾“å…¥å¸ç§ From å’Œ To');
Â Â if(!Number.isFinite(amount)||amount<=0) return alert('æ•°é‡å¿…é¡»æ˜¯å¤§äº 0 çš„æ•°å­—');
Â Â 
Â Â // 1. è·å–å½“å‰æŸ¥è¯¢æ¨¡å¼
Â Â const mode = qs('input[name="mode"]:checked').value;
Â Â queryPair={from,to,fromNetwork:fromNet,toNetwork:toNet,amount,mode:mode};
Â Â 
Â Â // 2. ğŸ”¥ éµå¾ªæ‚¨çš„é€»è¾‘ï¼šå‰ç«¯ä»…ç­›é€‰ã€ç”¨æˆ·é€‰ä¸­çŠ¶æ€ã€‘ã€‚æ¨¡å¼ç­›é€‰äº¤ç»™åç«¯å¤„ç†ï¼Œç¡®ä¿ä¸åç«¯æ¥å£ç¨³å®šäº¤äº’ã€‚
Â Â const sendAdapters = currentAdapters.filter(a => a.selected !== false); 
Â Â 
Â Â // æ¸…ç©ºæ—§ç»“æœå’Œæç¤º
Â Â qsa('table tbody').forEach(t=>t.innerHTML=''); 
Â Â qsa('.summary').forEach(s=>s.style.display='none'); 
Â Â byId('copyJson').style.display='none';
Â Â 
Â Â if(!sendAdapters.length){
Â Â Â Â byId('status').textContent=`âŒ æœªæ‰¾åˆ°å·²é€‰ä¸­çš„é€‚é…å™¨`;
Â Â Â Â return;
Â Â }
Â Â 
Â Â byId('status').textContent='æŸ¥è¯¢ä¸­...'; byId('warnings').innerHTML='';
Â Â 
Â Â const controller=new AbortController(),timeout=setTimeout(()=>controller.abort(),15000);
Â Â try{
Â Â Â Â const r=await fetch(WORKER_URL,{method:'POST',headers:{'content-type':'application/json'},signal:controller.signal,body:JSON.stringify({pair:queryPair,adapters:sendAdapters})});
Â Â Â Â if(!r.ok) throw new Error(await r.text()||`HTTP ${r.status}`);
Â Â Â Â const rj=await r.json(); lastResults=rj; showResults(rj);
Â Â Â Â 
Â Â Â Â // æˆåŠŸè·å–ç»“æœåï¼Œå­˜å‚¨æœ¬æ¬¡æŸ¥è¯¢å‚æ•°å¹¶æ›´æ–°åˆ—è¡¨
Â Â Â Â addHistory(queryPair); 
Â Â Â Â renderHistory();
Â Â Â Â 
Â Â Â Â byId('status').textContent=`å®Œæˆï¼Œå…± ${rj.results.length} æ¡ï¼Œè€—æ—¶ ${rj.timeTaken||'?'}ms`;
Â Â Â Â byId('copyJson').style.display='inline-block';
Â Â }catch(e){byId('status').textContent=e.name==='AbortError'?'è¯·æ±‚è¶…æ—¶':'é”™è¯¯: '+e.message;}
Â Â finally{clearTimeout(timeout);}
};

/* ---------- ç»“æœå±•ç¤º ---------- */
function showResults(res){
Â Â const all=res.results||[], floating=all.filter(r=>r.rateType==='floating'), locked=all.filter(r=>r.rateType==='locked');
Â Â const sort=(a,b)=>(b.outputAmount??-Infinity)-(a.outputAmount??-Infinity);
Â Â floating.sort(sort); locked.sort(sort);
Â Â qs('#floatingTable tbody').innerHTML=buildRateRows(floating,0);
Â Â qs('#lockedTable tbody').innerHTML=buildRateRows(locked,0);
Â Â renderSummary(floating.filter(r=>r.ok),'#floatingSummary',floating[0]);
Â Â renderSummary(locked.filter(r=>r.ok),'#lockedSummary',locked[0]);
Â Â const wDiv=byId('warnings'); wDiv.innerHTML='';
Â Â (res.warnings||[]).forEach(w=>{
Â Â Â Â const div=document.createElement('div'); div.className='warn-item';
Â Â Â Â div.textContent=`âš ï¸ [${w.adapter||'å…¨å±€'}]: ${w.message||w.error||'è­¦å‘Š'}`; wDiv.appendChild(div);
Â Â });
}
function renderSummary(data,sel,best){
Â Â const div=qs(sel);
Â Â if(!data.length||!best?.outputAmount){div.style.display='none';return;}
Â Â div.style.display='block';
Â Â div.innerHTML=`<p>è¾“å…¥: <b>${queryPair.amount} ${queryPair.from}</b></p><p>æœ€ä¼˜ (<b>${escapeHtml(best.name)}</b>): <b style="color:green;font-size:1.2em">${Number(best.outputAmount).toFixed(6)} ${queryPair.to}</b></p>`;
}

/* ---------- å¯¼å…¥ / å¤åˆ¶ ---------- */
byId('importBtn').onclick=async()=>{
Â Â const text=byId('importJson').value.trim(), pass=byId('adminPass').value.trim();
Â Â if(!pass) return alert('è¯·å…ˆè¾“å…¥ç®¡ç†å¯†ç ');
Â Â if(!text) return alert('è¯·ç²˜è´´é€‚é…å™¨ JSON');
Â Â let adapter; try{
Â Â Â Â adapter=JSON.parse(text);
Â Â Â Â if(!adapter||typeof adapter!=='object'||Array.isArray(adapter)||!adapter.name) throw new Error('ç¼ºå°‘ name');
Â Â }catch(e){return alert('JSON æ ¼å¼é”™è¯¯: '+e.message);}
Â Â const exist=currentAdapters.find(a=>a.name===adapter.name);
Â Â if(exist&&!confirm(`è¦†ç›–åŒåé€‚é…å™¨ã€${adapter.name}ã€‘ï¼Ÿ`)) return;
Â Â if(exist) currentAdapters=currentAdapters.filter(a=>a.name!==adapter.name);
Â Â currentAdapters.push(adapter);
Â Â try{await saveAllAdapters(false); byId('importJson').value=''; alert(`ã€${adapter.name}ã€‘å¯¼å…¥æˆåŠŸ`); renderAdapters();}
Â Â catch(err){alert(err.message);}
};
byId('copyJson').onclick=()=>{
Â Â if(!lastResults) return alert('æ— æ•°æ®');
Â Â const txt=JSON.stringify(lastResults,null,2);
Â Â navigator.clipboard.writeText(txt).then(()=>alert('å·²å¤åˆ¶')).catch(()=>prompt('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶:',txt));
};

/* ---------- è‡ªåŠ¨åŠ è½½ ---------- */
async function autoLoadPublicAdapters(){
Â Â if(currentAdapters.length||!WORKER_URL||WORKER_URL.includes('your-worker')) return;
Â Â try{
Â Â Â Â const r=await fetch(WORKER_URL+'/getAdapters');
Â Â Â Â if(!r.ok) throw new Error();
Â Â Â Â const list=await r.json();
Â Â Â Â if(Array.isArray(list)&&list.length){ currentAdapters=list; renderAdapters(); byId('status').textContent=`å…¬å¼€é€‚é…å™¨åŠ è½½æˆåŠŸï¼ˆ${list.length} ä¸ªï¼‰`; }
Â Â }catch{ byId('status').textContent='æš‚æ— å…¬å¼€é€‚é…å™¨ï¼Œç®¡ç†å‘˜è¯·åŠ è½½é…ç½®'; }
}
autoLoadPublicAdapters();

/* ---------- é‚®ç®±åçˆ¬ ---------- */
const setupEmail=()=>{const u='yanfei6868',d='icloud.com',m=u+'@'+d; byId('mail').href='mailto:'+m; byId('mail').textContent='ğŸ“§ '+m;};
setupEmail();

/* ---------- äººç±»å‹å¥½æ¨¡å¼ / æ ¸ååº”å †æ¨¡å¼ å¼€å…³ ---------- */
function toggleProMode(on){
Â Â document.body.classList.toggle('reactor-mode',on);
Â Â document.body.classList.toggle('simple-mode',!on);
Â Â const lbl=byId('modeLabel');
Â Â lbl.textContent= on?'æ ¸ååº”å †æ¨¡å¼ï¼ˆå±•å¼€å…¨éƒ¨ï¼‹éšè—å­—æ®µï¼‰':'äººç±»å‹å¥½æ¨¡å¼ï¼ˆæç®€é…ç½®ï¼‰';
Â Â lbl.style.background= on?'#ff5757':'#28a745';
Â Â 
Â Â if (visibleAdapterIndex === 'all') {
Â Â Â Â renderAdapters();
Â Â }
}

// *** å…³é”®ä¿®å¤ï¼šæ‰‹åŠ¨ç»‘å®š modeLabel çš„ç‚¹å‡»äº‹ä»¶ ***
const proModeCheckbox = byId('proMode');
byId('modeLabel').onclick = (e) => {
Â Â Â Â // é˜»æ­¢ç‚¹å‡» label å¯¼è‡´ input é»˜è®¤è¡Œä¸ºï¼ˆå¦‚æœé»˜è®¤è¡Œä¸ºè¿˜åœ¨ï¼‰
Â Â Â Â e.preventDefault(); 
Â Â Â Â // åˆ‡æ¢ checkbox çŠ¶æ€
Â Â Â Â proModeCheckbox.checked = !proModeCheckbox.checked;
Â Â Â Â // è°ƒç”¨åˆ‡æ¢å‡½æ•°
Â Â Â Â toggleProMode(proModeCheckbox.checked);
};
// ç¡®ä¿åˆå§‹çŠ¶æ€è®¾ç½®æ­£ç¡®
proModeCheckbox.checked=false; 
toggleProMode(false);

// ğŸ”¥ã€ä¿®æ”¹ç‚¹ Bã€‘: ç»‘å®šæ¸…ç©ºæŒ‰é’®äº‹ä»¶
byId('clearHistoryBtn').onclick = () => {
Â Â Â Â if (confirm("ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å†å²æŸ¥è¯¢è®°å½•å—ï¼Ÿ")) {
Â Â Â Â Â Â Â Â localStorage.removeItem(HISTORY_KEY);
Â Â Â Â Â Â Â Â renderHistory();
Â Â Â Â Â Â Â Â byId('status').textContent = 'âœ… å†å²è®°å½•å·²æ¸…ç©ºã€‚';
Â Â Â Â }
};

/* ---------- é¡µé¢åŠ è½½åˆå§‹åŒ– ---------- */
// è°ƒç”¨ä¸€æ¬¡å†å²è®°å½•æ¸²æŸ“
renderHistory(); 

</script>
</body>
</html>
